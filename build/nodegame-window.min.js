/**
 * # GameWindow
 * Copyright(c) 2017 Stefano Balietti <ste@nodegame.org>
 * MIT Licensed
 *
 * API to interface nodeGame with the browser window
 *
 * Creates a custom root element inside the HTML page, and insert an
 * iframe element inside it.
 *
 * Dynamic content can be loaded inside the iframe without losing the
 * javascript state inside the page.
 *
 * Defines a number of profiles associated with special page layout.
 *
 * Depends on JSUS and nodegame-client.
 */
(function(e,t){"use strict";function f(e,t){function r(i){var s;s=J.getIFrameDocument(e),e.removeEventListener("load",r,!1),n.removeEventListener("load",r,!1),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.addEventListener("load",r,!1),n.addEventListener("load",r,!1)}function l(e,t){function r(i){var s;s=J.getIFrameDocument(e);if(i.type==="load"||s.readyState==="complete")e.detachEvent("onreadystatechange",r),n.detachEvent("onload",r),t&&setTimeout(function(){t()},120)}var n;n=e.contentWindow,e.attachEvent("onreadystatechange",r),n.attachEvent("onload",r)}function c(e,t){W.isIE?l(e,t):f(e,t)}function h(){this.setStateLevel("UNINITIALIZED");if("undefined"==typeof e)throw new Error("GameWindow: no window found. Are you in a browser?");if("undefined"==typeof t)throw new Error("GameWindow: nodeGame not found");t.silly("node-window: loading..."),this.frameName=null,this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null,this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.defaultHeaderPosition="top",this.conf={},this.uriChannel=null,this.areLoading=0,this.cacheSupported=null,this.directFrameDocumentAccess=null,this.cache={},this.currentURIs={},this.unprocessedUri=null,this.globalLibs=[],this.frameLibs={},this.uriPrefix=null,this.stateLevel=null,this.waitScreen=null,this.listenersAdded=null,this.screenState=t.constants.screenLevels.ACTIVE,this.isIE=!!document.createElement("span").attachEvent,this.headerOffset=0,this.willResizeFrame=!1,this.addDefaultSetups(),this.addDefaultListeners(),setTimeout(function(){(function(e){e.length>=1&&(e[0].style.display="none")})(document.getElementsByTagName("noscript"))},1e3),this.init(h.defaults),t.silly("node-window: created.")}function p(e,t,n,r,i,s,o){var u,a;n=W.getElementById(r),u=W.getIFrameDocument(n).documentElement,i&&(u.innerHTML=e.cache[t].contents),r===e.frameName&&(e.frameWindow=n.contentWindow,e.frameDocument=e.getIFrameDocument(n),e.conf.rightClickDisabled&&J.disableRightClick(e.frameDocument),e.conf.noEscape&&(e.frameDocument.onkeydown=document.onkeydown)),d(n),a=function(){m(n,e.globalLibs.concat(e.frameLibs.hasOwnProperty(t)?e.frameLibs[t]:[])),s&&(e.cache[t].contents=u.innerHTML),o(),W.adjustFrameHeight(0,120)},i?v(n,a):a()}function d(e){var t,n,r,i;n=W.getIFrameDocument(e),r=W.getElementsByClassName(n,"injectedlib","script");for(t=0;t<r.length;t++)i=r[t],i.parentNode.removeChild(i)}function v(e,t){var n,r,i,s,o,u,a,f,l,c;n=W.getIFrameDocument(e),r=W.getIFrameAnyChild(e),l=1,s=n.getElementsByTagName("script");for(o=0;o<s.length;o++){i=s[o],i.parentNode.removeChild(i),u=document.createElement("script"),i.innerHTML&&(u.innerHTML=i.innerHTML),c=!1;for(a=0;a<i.attributes.length;a++)f=i.attributes[a],u.setAttribute(f.name,f.value),f.name==="src"&&(c=!0);c&&(++l,u.onload=function(e){return function(){e.onload=null,--l,l<=0&&t()}}(u)),r.appendChild(u)}--l,l<=0&&t()}function m(e,t){var n,r,i,s;n=W.getIFrameAnyChild(e);for(i=0;i<t.length;i++)s=t[i],r=document.createElement("script"),r.className="injectedlib",r.src=s,n.appendChild(r)}function g(e,t){return e.areLoading=e.areLoading+t,e.areLoading===0}function y(e){var t,n,r;n=W.getFrame();if(!n)return;r=W.getHeader(),t=W.headerPosition||"top",e==="bottom"&&t!=="bottom"&&W.getFrameRoot().insertBefore(W.headerElement,n),W.removeClass(n,"ng_mainframe-header-[a-z-]*");switch(t){case"right":W.addClass(n,"ng_mainframe-header-vertical-r");break;case"left":W.addClass(n,"ng_mainframe-header-vertical-l");break;case"top":W.addClass(n,"ng_mainframe-header-horizontal-t"),r&&W.getFrameRoot().insertBefore(r,n);break;case"bottom":W.addClass(n,"ng_mainframe-header-horizontal-b"),r&&W.getFrameRoot().insertBefore(r,n.nextSibling)}}function b(e){try{e.frameDocument.getElementById("test"),e.directFrameDocumentAccess=!0}catch(t){e.directFrameDocumentAccess=!1}}var n,r,i,s,o,u,a;if(!J)throw new Error("GameWindow: JSUS not found. Aborting.");n=J.require("DOM");if(!n)throw new Error('GameWindow: J.require("DOM") failed.');r=t.constants,i=r.windowLevels,s=r.screenLevels,o=r.stageLevels.CALLBACK_EXECUTED,u=i.LOADING,a=!1,h.prototype=n,h.prototype.constructor=h,h.defaults={},h.defaults.promptOnleaveText="",h.defaults.promptOnleave=!0,h.defaults.noEscape=!0,h.defaults.waitScreen=undefined,h.defaults.disableRightClick=!1,h.defaults.cacheDefaults={loadCache:!0,storeCacheNow:!1,storeCacheLater:!1},h.defaults.infoPanel=undefined,h.prototype.init=function(e){var n,i;this.setStateLevel("INITIALIZING"),e=e||{},this.conf=J.merge(this.conf,e),this.conf.promptOnleave?this.promptOnleave():this.conf.promptOnleave===!1&&this.restoreOnleave(),"undefined"==typeof this.conf.noEscape||this.conf.noEscape?this.noEscape():this.conf.noEscape===!1&&this.restoreEscape(),this.conf.waitScreen!==!1?(this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.waitScreen=new t.WaitScreen(this.conf.waitScreen),n=r.stageLevels,i=t.game.getStageLevel(),i!==n.UNINITIALIZED&&(t.game.paused?this.lockScreen(this.waitScreen.defaultTexts.paused):i===n.DONE?this.lockScreen(this.waitScreen.defaultTexts.waiting):i!==n.PLAYING&&this.lockScreen(this.waitScreen.defaultTexts.stepping))):this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.conf.defaultHeaderPosition&&(this.defaultHeaderPosition=this.conf.defaultHeaderPosition),this.conf.disableRightClick?this.disableRightClick():this.conf.disableRightClick===!1&&this.enableRightClick(),"undefined"!=typeof this.conf.disableBackButton&&this.disableBackButton(this.conf.disableBackButton),"undefined"!=typeof this.conf.uriPrefix&&this.setUriPrefix(this.conf.uriPrefix),this.setStateLevel("INITIALIZED"),t.silly("node-window: inited.")},h.prototype.reset=function(){this.isScreenLocked()&&this.unlockScreen(),t.widgets&&t.widgets.destroyAll(),this.getFrame()&&this.destroyFrame(),this.getHeader()&&this.destroyHeader(),this.areLoading=0,this.clearCache(),t.silly("node-window: reseted.")},h.prototype.setStateLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setStateLevel: level must be string. Found: "+e);if("undefined"==typeof i[e])throw new Error("GameWindow.setStateLevel: unrecognized level: "+e);this.stateLevel=i[e]},h.prototype.getStateLevel=function(){return this.stateLevel},h.prototype.isReady=function(){return this.stateLevel===i.LOADED||this.stateLevel===i.INITIALIZED},h.prototype.setScreenLevel=function(e){if("string"!=typeof e)throw new TypeError("GameWindow.setScreenLevel: level must be string. Found: "+e);if("undefined"==typeof s[e])throw new Error("GameWindow.setScreenLevel: unrecognized level: "+e);this.screenState=s[e]},h.prototype.getScreenLevel=function(){return this.screenState},h.prototype.getFrame=function(){return this.frameElement||this.frameName&&(this.frameElement=document.getElementById(this.frameName)),this.frameElement},h.prototype.getFrameName=function(){var e;if(!this.frameName||this.stateLevel===u)e=this.getFrame(),this.frameName=e?e.name||e.id:null;return this.frameName},h.prototype.getFrameWindow=function(){var e;if(!this.frameWindow||this.stateLevel===u)e=this.getFrame(),this.frameWindow=e?e.contentWindow:null;return this.frameWindow},h.prototype.getFrameDocument=function(){var e;if(!this.frameDocument||this.stateLevel===u){e=this.getFrame();if(!e)return null;this.frameDocument=this.getIFrameDocument(e)}return this.directFrameDocumentAccess?this.frameDocument:J.getIFrameDocument(this.getFrame())},h.prototype.getFrameRoot=function(){var e;return this.frameRoot||(e=this.getFrame(),this.frameRoot=e?e.parentNode:null),this.frameRoot},h.prototype.generateFrame=function(e,n,r){var i;if(this.frameElement){if(!r)throw new Error("GameWindow.generateFrame: frame is already existing. Use force to regenerate.");this.destroyFrame()}e=e||this.frameRoot||document.body;if(!J.isElement(e))throw new Error("GameWindow.generateFrame: root must be undefined or HTMLElement. Found: "+e);n=n||"ng_mainframe";if("string"!=typeof n||n.trim()==="")throw new Error("GameWindow.generateFrame: frameName must be undefined or a non-empty string. Found: "+n);if(document.getElementById(n))throw new Error("GameWindow.generateFrame: frameName is not unique in DOM: "+n);return i=W.add("iframe",e,n),i.contentWindow.location.replace("about:blank"),i.frameBorder=0,i.scrolling="no",this.setFrame(i,n,e),this.getHeader()&&y(),t.events.ng.emit("FRAME_GENERATED",i),document.body.onresize=function(){W.adjustFrameHeight(0,120)},i},h.prototype.generateInfoPanel=function(e,n,r){var i;if(this.infoPanel){if(!r)throw new Error("GameWindow.generateInfoPanel: info panel is already existing. Use force to regenerate.");this.infoPanel.destroy(),this.infoPanel=null}n=n||{},this.infoPanel=new t.InfoPanel(n),i=this.infoPanel.infoPanelDiv,e=n.root;if(e){if(!J.isElement(e))throw new Error("GameWindow.generateInfoPanel: root must be undefined or HTMLElement. Found: "+e);e.appendChild(i)}else this.frameElement?document.body.insertBefore(i,this.frameElement):this.headerElement?J.insertAfter(this.headerElement,i):document.body.appendChild(i);return t.events.ng.emit("INFOPANEL_GENERATED",this.infoPanel),this.infoPanel},h.prototype.setFrame=function(e,t,n){if(!J.isElement(e))throw new TypeError("GameWindow.setFrame: iframe must be HTMLElement. Found: "+e);if("string"!=typeof t)throw new TypeError("GameWindow.setFrame: iframeName must be string. Found: "+t);if(!J.isElement(n))throw new TypeError("GameWindow.setFrame: root must be HTMLElement. Found: "+n);return this.frameRoot=n,this.frameName=t,this.frameElement=e,this.frameWindow=e.contentWindow,this.frameDocument=W.getIFrameDocument(e),e},h.prototype.destroyFrame=function(){this.clearFrame(),this.frameRoot&&this.frameRoot.removeChild(this.frameElement),this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null},h.prototype.clearFrame=function(){var t,n,r;t=this.getFrame();if(!t)throw new Error("GameWindow.clearFrame: cannot detect frame.");n=t.name||t.id,t.onload=null,r=this.getFrameDocument(),r.documentElement.innerHTML="",this.directFrameDocumentAccess?r.documentElement.innerHTML="":J.removeChildrenFromNode(r.documentElement),this.frameElement=t,this.frameWindow=e.frames[n],this.frameDocument=W.getIFrameDocument(t)},h.prototype.generateHeader=function(e,t,n){var r;if(this.headerElement){if(!n)throw new Error("GameWindow.generateHeader: header is already existing. Use force to regenerate.");this.destroyHeader()}e=e||document.body||document.lastElementChild;if(!J.isElement(e))throw new Error("GameWindow.generateHeader: root must be undefined or HTMLElement. Found: "+e);t=t||"ng_header";if("string"!=typeof t)throw new Error("GameWindow.generateHeader: headerName must be string. Found: "+t);if(document.getElementById(t))throw new Error("GameWindow.generateHeader: headerName is not unique in DOM: "+t);return r=this.add("div",e,t),this.frameElement&&this.defaultHeaderPosition!=="bottom"&&this.getFrameRoot().insertBefore(r,this.frameElement),this.setHeader(r,t,e),this.setHeaderPosition(this.defaultHeaderPosition),r},h.prototype.setHeaderPosition=function(){var e;return e={top:"ng_header_position-horizontal-t",bottom:"ng_header_position-horizontal-b",right:"ng_header_position-vertical-r",left:"ng_header_position-vertical-l"},function(n){var r,i;if("string"!=typeof n)throw new TypeError("GameWindow.setHeaderPosition: position must be string. Found: "+n);r=n.toLowerCase();if(this.headerPosition===r)return;if("undefined"==typeof e[r]){t.err("GameWindow.setHeaderPosition: invalid header position: "+r);return}if(!this.headerElement)throw new Error("GameWindow.setHeaderPosition: headerElement not found.");W.removeClass(this.headerElement,"ng_header_position-[a-z-]*"),W.addClass(this.headerElement,e[r]),i=this.headerPosition,this.headerPosition=r,this.frameElement&&y(i)}}(),h.prototype.setHeader=function(e,n,r){if(!J.isElement(e))throw new Error("GameWindow.setHeader: header must be HTMLElement. Found: "+e);if("string"!=typeof n)throw new Error("GameWindow.setHeader: headerName must be string. Found: "+n);if(!J.isElement(r))throw new Error("GameWindow.setHeader: root must be HTMLElement. Found: "+r);return this.headerElement=e,this.headerName=n,this.headerRoot=r,t.events.ng.emit("HEADER_GENERATED",e),this.headerElement},h.prototype.getHeader=function(){return this.headerElement||(this.headerElement=this.headerName?document.getElementById(this.headerName):null),this.headerElement},h.prototype.getHeaderName=function(){var e;return this.headerName||(e=this.getHeader(),this.headerName=e?e.id:null),this.headerName},h.prototype.getHeaderRoot=function(){var e;return this.headerRoot||(e=this.getHeader(),this.headerRoot=e?e.parentNode:null),this.headerRoot},h.prototype.destroyHeader=function(){this.clearHeader(),this.headerRoot.removeChild(this.headerElement),this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.headerOffset=0,this.adjustHeaderOffset(!0)},h.prototype.clearHeader=function(){var e;e=this.getHeader();if(!e)throw new Error("GameWindow.clearHeader: cannot detect header.");this.headerElement.innerHTML=""},h.prototype.initLibs=function(e,t){if(e&&!J.isArray(e))throw new TypeError("GameWindow.initLibs: globalLibs must be array or undefined. Found: "+e);if(t&&"object"!=typeof t)throw new TypeError("GameWindow.initLibs: frameLibs must be object or undefined. Found: "+t);if(!e&&!t)throw new Error("GameWindow.initLibs: frameLibs and frameLibs cannot be both undefined.");this.globalLibs=this.globalLibs.concat(e||[]),J.mixin(this.frameLibs,t)},h.prototype.preCacheTest=function(e,t){var n,r;t=t||"/pages/testpage.htm";if("string"!=typeof t)throw new TypeError("GameWindow.precacheTest: uri must string or undefined. Found: "+t);n=document.createElement("iframe"),n.style.display="none",r="preCacheTest",n.id=r,n.name=r,document.body.appendChild(n),n.contentWindow.location.replace(t),c(n,function(){try{W.getIFrameDocument(n).documentElement.innerHTML="a",W.cacheSupported=!0}catch(t){W.cacheSupported=!1}document.body.removeChild(n),e&&e()})},h.prototype.preCache=function(n,r){var i,s,o,u,a,f;"string"==typeof n&&(n=[n]);if(!J.isArray(n))throw new TypeError("GameWindow.preCache: uris must be string or array. Found: "+n);if(r&&"function"!=typeof r)throw new TypeError("GameWindow.preCache: callback must be function or undefined. Found: "+r);if(!n.length){r&&r();return}i=this;if(this.cacheSupported===null){this.preCacheTest(function(){i.preCache(n,r)});return}if(this.cacheSupported===!1){t.warn("GameWindow.preCache: caching is not supported by your browser."),r&&r();return}s=0;for(u=0;u<n.length;u++)o=this.processUri(n[u]),a=document.createElement("iframe"),a.style.display="none",f="tmp_iframe_"+u,a.id=f,a.name=f,document.body.appendChild(a),function(e,t){c(t,function(){var o,u;o=W.getIFrameDocument(t),u=o.documentElement,i.cache[e]={contents:u.innerHTML,cacheOnClose:!1},document.body.removeChild(t),s++,s>=n.length&&r&&r()})}(o,a),e.frames[f].location.replace(o)},h.prototype.clearCache=function(){this.cache={}},h.prototype.getElementById=h.prototype.gid=function(e){var t,n;return n=this.getFrameDocument(),t=null,n&&n.getElementById&&(t=n.getElementById(e)),t||(t=document.getElementById(e)),t},h.prototype.getElementsByTagName=function(e){var t;return t=this.getFrameDocument(),t?t.getElementsByTagName(e):document.getElementsByTagName(e)},h.prototype.getElementsByClassName=function(e,t){var n;return n=this.getFrameDocument()||document,J.getElementsByClassName(n,e,t)},h.prototype.loadFrame=function(e,n,r){var i,s,o,u,a,f,l,d,v,m,y,w,E,S;if("string"!=typeof e)throw new TypeError("GameWindow.loadFrame: uri must be string. Found: "+e);if(n&&"function"!=typeof n)throw new TypeError("GameWindow.loadFrame: func must be function or undefined. Found: "+n);if(r&&"object"!=typeof r)throw new TypeError("GameWindow.loadFrame: opts must be object or undefined. Found: "+r);r=r||{},d=this.getFrame(),v=this.frameName;if(!d)throw new Error("GameWindow.loadFrame: no frame found.");if(!v)throw new Error("GameWindow.loadFrame: frame has no name.");this.setStateLevel("LOADING"),i=this,y=d.contentWindow,m=W.getIFrameDocument(d),E=m.readyState,E=E==="complete",s=h.defaults.cacheDefaults.loadCache,o=h.defaults.cacheDefaults.storeCacheNow,u=h.defaults.cacheDefaults.storeCacheLater;if(r.cache){if(r.cache.loadMode)if(r.cache.loadMode==="reload")s=!1;else{if(r.cache.loadMode!=="cache")throw new Error("GameWindow.loadFrame: unkown cache load mode: "+r.cache.loadMode);s=!0}if(r.cache.storeMode)if(r.cache.storeMode==="off")o=!1,u=!1;else if(r.cache.storeMode==="onLoad")o=!0,u=!1;else{if(r.cache.storeMode!=="onClose")throw new Error("GameWindow.loadFrame: unkown cache store mode: "+r.cache.storeMode);o=!1,u=!0}}if("undefined"!=typeof r.autoParse){if("object"!=typeof r.autoParse)throw new TypeError("GameWindow.loadFrame: opts.autoParse must be object or undefined. Found: "+r.autoParse);if("undefined"!=typeof r.autoParsePrefix){if("string"!=typeof r.autoParsePrefix)throw new TypeError("GameWindow.loadFrame: opts.autoParsePrefix must be string or undefined. Found: "+r.autoParsePrefix);f=r.autoParsePrefix}if("undefined"!=typeof r.autoParseMod){if("string"!=typeof r.autoParseMod)throw new TypeError("GameWindow.loadFrame: opts.autoParseMod must be string or undefined. Found: "+r.autoParseMod);l=r.autoParseMod}a=r.autoParse}this.unprocessedUri=e;if(this.cacheSupported===null){this.preCacheTest(function(){i.loadFrame(e,n,r)});return}e=this.processUri(e),this.cacheSupported===!1?(o=!1,u=!1,s=!1):(S=this.currentURIs[v],this.cache.hasOwnProperty(S)&&this.cache[S].cacheOnClose&&(w=m.documentElement,this.cache[S].contents=w.innerHTML),this.cache.hasOwnProperty(e)||(this.cache[e]={contents:null,cacheOnClose:!1}),this.cache[e].cacheOnClose=u,this.cache[e].contents===null&&(s=!1)),this.currentURIs[v]=e,g(this,1),(!s||!E)&&c(d,function(){i.directFrameDocumentAccess===null&&b(i),p(i,e,d,v,s,o,function(){i.updateLoadFrameState(n,a,l,f)})}),s?E&&p(this,e,d,v,s,o,function(){i.updateLoadFrameState(n,a,l,f)}):y.location.replace(e),y.node=t},h.prototype.processUri=function(e){return e.charAt(0)!=="/"&&e.substr(0,7)!=="http://"&&(this.uriPrefix&&(e=this.uriPrefix+e),this.uriChannel&&(e=this.uriChannel+e)),e},h.prototype.updateLoadFrameState=function(e,n,r,i){var s,u;s=g(this,-1),s&&this.setStateLevel("LOADED"),e&&e.call(t.game),n&&this.searchReplace(n,r,i),t.events.ee.game.emit("FRAME_LOADED"),t.events.ee.stage.emit("FRAME_LOADED"),t.events.ee.step.emit("FRAME_LOADED"),s?(u=t.game.getStageLevel(),u===o&&t.emit("LOADED")):t.silly("game-window: "+this.areLoading+" frames "+"still loading.")},h.prototype.clearPageBody=function(){this.reset(),document.body.innerHTML=""},h.prototype.clearPage=function(){this.reset();try{document.documentElement.innerHTML=""}catch(e){this.removeChildrenFromNode(document.documentElement)}},h.prototype.setUriPrefix=function(e){if(e!==null&&"string"!=typeof e)throw new TypeError("GameWindow.setUriPrefix: uriPrefix must be string or null. Found: "+e);this.conf.uriPrefix=this.uriPrefix=e},h.prototype.setUriChannel=function(e){if("string"==typeof e)e.charAt(0)!=="/"&&(e="/"+e),e.charAt(e.length-1)!=="/"&&(e+="/");else if(e!==null)throw new TypeError("GameWindow.uriChannel: uriChannel must be string or null. Found: "+e);this.uriChannel=e},h.prototype.adjustFrameHeight=function(){var t,n;return n=function(t){var n,r,i;W.adjustHeaderOffset(),n=W.getFrame();if(!n||!n.contentWindow)return;r=e.innerHeight||e.clientHeight,i=n.contentWindow.document.body.offsetHeight,i+=60,W.headerPosition==="top"&&(i+=W.headerOffset),r<i&&(r=i),r<(t||0)&&(r=t),n.style["min-height"]=r+"px"},function(e,r){if("undefined"==typeof r){n(e);return}if(W.willResizeFrame){t=!0;return}W.willResizeFrame=setTimeout(function(){W.willResizeFrame=null,t?(t=!1,W.adjustFrameHeight(e,r)):n(e)},r)}}(),h.prototype.adjustHeaderOffset=function(e){var t,n,r,i,s,o;r=W.getHeader(),t=W.headerPosition;if(!e&&(!r&&W.headerOffset||t==="top"&&r.offsetHeight===W.headerOffset))return;n=W.getFrame(),i=W.infoPanel;if(!n&&!i)return;switch(t){case"top":s=r?r.offsetHeight:0,o=s+"px",i&&i.isVisible?(i.infoPanelDiv.style["padding-top"]=o,n.style["padding-top"]=0):(i&&i.infoPanelDiv&&(i.infoPanelDiv.style["padding-top"]=0),n.style["padding-top"]=o);break;case"bottom":s=r?r.offsetHeight:0,o=s+"px",n.style["padding-bottom"]=o,i&&i.infoPanelDiv&&(i.infoPanelDiv.style["padding-top"]=0);break;case"right":s=r?r.offsetWidth:0,o=s+"px",n&&(n.style["padding-right"]=o),i&&i.isVisible&&(i.infoPanelDiv.style["padding-right"]=o);break;case"left":s=r?r.offsetWidth:0,o=s+"px",n&&(n.style["padding-left"]=o),i&&i.isVisible&&(i.infoPanelDiv.style["padding-left"]=o);break;default:if(t!==null)throw new Error("GameWindow.adjustHeaderOffset: invalid header position. Found: "+t);if(r)throw new Error("GameWindow.adjustHeaderOffset: something is wrong. Header found, but position is null.");n&&(n.style.padding=0),i&&i.infoPanelDiv&&(i.infoPanelDiv.padding=0)}W.headerOffset=s},t.GameWindow=h})("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){var n=t.GameWindow;n.prototype.addDefaultSetups=function(){t.registerSetup("window",function(e){return this.window.init(e),e}),t.registerSetup("page",function(e){var t,n;if(!e)return;return e.clearBody&&this.window.clearPageBody(),e.clear&&this.window.clearPage(),"string"==typeof e.title&&(e.title={title:e.title}),"object"==typeof e.title&&(document.title=e.title.title,e.title.addToBody&&(t=document.createElement("h1"),t.className="ng-page-title",t.innerHTML=e.title.title,n=document.body,n.innerHTML===""?n.appendChild(t):n.insertBefore(t,n.firstChild))),e}),t.registerSetup("frame",function(e){var n,r,i,s,o,u,a;if(!e)return;if(e.generate){if("object"!=typeof e.generate){t.warn("node.setup.frame: conf.generate must be object or undefined.");return}if(e.generate.root){if("string"!=typeof e.generate.root){t.warn("node.setup.frame: conf.generate.root must be string or undefined.");return}a=e.generate.root,o=e.generate.force,s=e.generate.name}u=this.window.getElementById(a),u||(u=this.window.getScreen());if(!u){t.warn("node.setup.frame: could not find valid root element to generate new frame.");return}this.window.generateFrame(u,s,o)}"undefined"!=typeof e.uriPrefix&&this.window.setUriPrefix(e.uriPrefix);if(e.load){if("object"==typeof e.load)n=e.load.url,r=e.load.cb,i=e.load.options;else{if("string"!=typeof e.load){t.warn("node.setup.frame: conf.load must be string, object or undefined.");return}n=e.load}this.window.loadFrame(n,r,i)}return e.clear&&this.window.clearFrame(),e.destroy&&this.window.destroyFrame(),e}),t.registerSetup("header",function(e){var n,r,i,s;if(!e)return;if(e.generate){if("object"!=typeof e.generate){t.warn("node.setup.header: conf.generate must be object or undefined.");return}if(e.generate.root){if("string"!=typeof e.generate.root){t.warn("node.setup.header: conf.generate.root must be string or undefined.");return}s=e.generate.root,r=e.generate.force,n=e.generate.name}i=this.window.getElementById(s),i||(i=this.window.getScreen());if(!i){t.warn("node.setup.header: could not find valid root element to generate new header.");return}this.window.generateHeader(i,n,r)}if(e.position){if("string"!=typeof e.position){t.warn("node.setup.header: conf.position must be string or undefined.");return}this.window.setHeaderPosition(e.position)}return e.clear&&this.window.clearHeader(),e.destroy&&this.window.destroyHeader(),e})}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.GameWindow,r=t.JSUS;n.prototype.noEscape=function(){var t;e.document.onkeydown=function(t){var n=e.event?event.keyCode:t.keyCode;if(n===27)return!1},t=this.getFrameDocument(),t&&(t.onkeydown=e.document.onkeydown),this.conf.noEscape=!0},n.prototype.restoreEscape=function(){var t;e.document.onkeydown=null,t=this.getFrameDocument(),t&&(t.onkeydown=null),this.conf.noEscape=!1},n.prototype.promptOnleave=function(t,n){t=t||e,n="undefined"!=typeof n?n:this.conf.promptOnleaveText,t.onbeforeunload=function(t){return t=t||e.event,t&&(t.returnValue=n),n},this.conf.promptOnleave=!0},n.prototype.restoreOnleave=function(t){t=t||e,t.onbeforeunload=null,this.conf.promptOnleave=!1},n.prototype.disableRightClick=function(){this.frameElement&&r.disableRightClick(this.getFrameDocument()),r.disableRightClick(document),this.conf.rightClickDisabled=!0},n.prototype.enableRightClick=function(){this.frameElement&&r.enableRightClick(this.getFrameDocument()),r.enableRightClick(document),this.conf.rightClickDisabled=!1},n.prototype.disableBackButton=function(e){this.conf.backButtonDisabled=r.disableBackButton(e)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";var n=t.GameWindow,r=t.constants.screenLevels;n.prototype.lockScreen=function(e,t){if(!this.waitScreen)throw new Error("GameWindow.lockScreen: waitScreen not found");if(e&&"string"!=typeof e)throw new TypeError("GameWindow.lockScreen: text must be string or undefined. Found: "+e);if(t&&"number"!=typeof t||t<0)throw new TypeError("GameWindow.lockScreen: countdown must be a positive number or undefined. Found: "+t);this.setScreenLevel("LOCKING"),e=e||"Screen locked. Please wait...",this.waitScreen.lock(e,t),this.setScreenLevel("LOCKED")},n.prototype.unlockScreen=function(){if(!this.waitScreen)throw new Error("GameWindow.unlockScreen: waitScreen not found.");if(!this.isScreenLocked())throw new Error("GameWindow.unlockScreen: screen is not locked.");this.setScreenLevel("UNLOCKING"),this.waitScreen.unlock(),this.setScreenLevel("ACTIVE")},n.prototype.isScreenLocked=function(){return this.getScreenLevel()!==r.ACTIVE}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){"use strict";function n(e,n){var r;if("string"==typeof e)r=W.getElementById(e);else{if(!t.isElement(e))throw new TypeError(n+": idOrObj must be string "+" or HTML Element.");r=e}return r}var t=e.JSUS,r=e.GameWindow;r.prototype.addDefaultListeners=function(t){return this.listenersAdded&&!t?(e.err("node.window.addDefaultListeners: listeners already added once. Use the force flag to re-add."),!1):(e.on("NODEGAME_GAME_CREATED",function(){W.init(e.conf.window)}),e.on("INPUT_DISABLE",function(e){W.toggleInputs(e,!0)}),e.on("INPUT_ENABLE",function(e){W.toggleInputs(e,!1)}),e.on("INPUT_TOGGLE",function(e){W.toggleInputs(e)}),window.onunload=function(){var t;e.socket.disconnect();for(t=-1;++t<1e5;);},this.listenersAdded=!0,e.silly("node-window: listeners added."),!0)}}("undefined"!=typeof node?node:undefined),function(e,t){"use strict";function i(e,t){var i,s,o,u;"undefined"==typeof t&&(t=!0);for(i=-1;++i<r;){o=e.getElementsByTagName(n[i]),u=o.length;for(s=-1;++s<u;)t?o[s].disabled||(o[s].disabled=!0,W.waitScreen.lockedInputs.push(o[s])):o[s].disabled&&(o[s].disabled=!1)}t||(W.waitScreen.lockedInputs=[])}function s(e){var t;e=e||W.waitScreen.defaultTexts.waiting,node.game.shouldStep()||(W.isScreenLocked()?W.waitScreen.updateText(e):(node.game.timer.milliseconds&&(t=node.game.timer.milliseconds-node.timer.getTimeSince("step",!0)+2e3,t<0&&(t=0)),W.lockScreen(e,t)))}function o(){var e;e=W.waitScreen.defaultTexts.stepping,W.isScreenLocked()?W.waitScreen.updateText(e):W.lockScreen(e)}function u(){W.isScreenLocked()&&W.unlockScreen()}function a(e){e=e||W.waitScreen.defaultTexts.paused,W.isScreenLocked()?(W.waitScreen.beforePauseInnerHTML=W.waitScreen.contentDiv.innerHTML,W.waitScreen.updateText(e)):W.lockScreen(e)}function f(){W.isScreenLocked()&&(W.waitScreen.beforePauseInnerHTML!==null?(W.waitScreen.updateText(W.waitScreen.beforePauseInnerHTML),W.waitScreen.beforePauseInnerHTML=null):W.unlockScreen())}function l(e){e=e||{},this.id=e.id||"ng_waitScreen",this.root=e.root||null,this.waitingDiv=null,this.beforePauseInnerHTML=null,this.enabled=!1,this.contentDiv=null,this.countdownDiv=null,this.countdownSpan=null,this.countdown=null,this.defaultTexts={waiting:e.waitingText||"Waiting for other players to be done...",stepping:e.steppingText||"Initializing game step, will be ready soon...",paused:e.pausedText||"Game is paused. Please wait."},this.lockedInputs=[],this.enable()}function c(e){var t;return t="",e=J.parseMilliseconds(e),e[2]&&(t+=e[2]+" min "),e[3]&&(t+=e[3]+" sec"),t||0}e.WaitScreen=l,l.version="0.9.0",l.description="Shows a standard waiting screen";var n,r;n=["button","select","textarea","input"],r=n.length,l.prototype.enable=function(){if(this.enabled)return;node.events.ee.game.on("REALLY_DONE",s),node.events.ee.game.on("STEPPING",o),node.events.ee.game.on("PLAYING",u),node.events.ee.game.on("PAUSED",a),node.events.ee.game.on("RESUMED",f),this.enabled=!0},l.prototype.disable=function(){if(!this.enabled)return;node.events.ee.game.off("REALLY_DONE",s),node.events.ee.game.off("STEPPING",o),node.events.ee.game.off("PLAYING",u),node.events.ee.game.off("PAUSED",a),node.events.ee.game.off("RESUMED",f),this.enabled=!1},l.prototype.lock=function(e,t){var n;"undefined"==typeof document.getElementsByTagName&&node.warn("WaitScreen.lock: cannot lock inputs."),i(document),n=W.getFrameDocument(),n&&i(n),this.waitingDiv||(this.root||(this.root=W.getFrameRoot()||document.body),this.waitingDiv=W.add("div",this.root,this.id),this.contentDiv=W.add("div",this.waitingDiv,"ng_waitscreen-content-div")),this.waitingDiv.style.display==="none"&&(this.waitingDiv.style.display=""),this.contentDiv.innerHTML=e,t?(this.countdownDiv||(this.countdownDiv=W.add("div",this.waitingDiv,"ng_waitscreen-countdown-div"),this.countdownDiv.innerHTML="<br>Do not refresh the page!<br>Maximum Waiting Time: ",this.countdownSpan=W.add("span",this.countdownDiv,"ng_waitscreen-countdown-span")),this.countdown=t,this.countdownSpan.innerHTML=c(t),this.countdownDiv.style.display="",this.countdownInterval=setInterval(function(){var e;e=W.waitScreen;if(!W.isScreenLocked()){clearInterval(e.countdownInterval);return}e.countdown-=1e3,e.countdown<0?(clearInterval(e.countdownInterval),e.countdownDiv.style.display="none",e.contentDiv.innerHTML="Resuming soon..."):e.countdownSpan.innerHTML=c(e.countdown)},1e3)):this.countdownDiv&&(this.countdownDiv.style.display="none")},l.prototype.unlock=function(){var e,t;this.waitingDiv&&this.waitingDiv.style.display===""&&(this.waitingDiv.style.display="none"),this.countdownInterval&&clearInterval(this.countdownInterval);try{t=this.lockedInputs.length;for(e=-1;++e<t;)this.lockedInputs[e].removeAttribute("disabled");this.lockedInputs=[]}catch(n){i(W.getIFrameDocument(W.getFrame()),!1)}},l.prototype.updateText=function(e,t){t=t||!1;if("string"!=typeof e)throw new TypeError("WaitScreen.updateText: text must be string. Found: "+e);t?this.contentDiv.innerHTML+=e:this.contentDiv.innerHTML=e},l.prototype.destroy=function(){W.isScreenLocked()&&(W.setScreenLevel("UNLOCKING"),this.unlock(),W.setScreenLevel("ACTIVE")),this.waitingDiv&&this.waitingDiv.parentNode&&this.waitingDiv.parentNode.removeChild(this.waitingDiv),this.disable()}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(e,t){"use strict";function n(e){this.init(e||{})}e.InfoPanel=n,n.prototype.init=function(e){var t;e=e||{},this.infoPanelDiv=document.createElement("div"),this.infoPanelDiv.id="ng_info-panel",this.actionsLog=[],this._buttons=[];if("undefined"==typeof e.className)this.infoPanelDiv.className="";else{if("string"!=typeof e.className)throw new TypeError("InfoPanel constructor: options.className must be a string or undefined. Found: "+e.className);this.infoPanelDiv.className=e.className}if("undefined"==typeof e.isVisible)this.isVisible=!1;else{if("boolean"!=typeof e.isVisible)throw new TypeError("InfoPanel constructor: options.isVisible must be a boolean or undefined. Found: "+e.isVisible);this.isVisible=e.isVisible}this.infoPanelDiv.style.display=this.isVisible?"block":"none",this.actionsLog.push({created:J.now()});if("undefined"!=typeof e.onStep){if("open"!==e.onStep&&"close"!==e.onStep&&"clear"!==e.onStep)throw new TypeError('InfoPanel constructor: options.onStep must be string "open", "close", "clear" or undefined. Found: '+e.onStep);this.onStep=e.onStep}else e.onStep=null;if("undefined"!=typeof e.onStage){if("open"!==e.onStage&&"close"!==e.onStage&&"clear"!==e.onStage)throw new TypeError('InfoPanel constructor: options.onStage must be string "open", "close", "clear" or undefined. Found: '+e.onStage);this.onStage=e.onStage}else e.onStage=null;if(this.onStep||this.onStage)t=this,node.events.game.on("STEPPING",function(e,n){var r;r=e.stage!==n.stage,t.onStep==="close"&&t.isVisible||r&&t.onStage==="close"?t.close():t.onStep==="open"||r&&t.onStage==="open"?t.open():(t.onStep==="clear"||r&&t.onStage==="clear")&&t.clear()})},n.prototype.clear=function(){this.infoPanelDiv.innerHTML="",this.actionsLog.push({clear:J.now()}),W.adjustHeaderOffset(!0)},n.prototype.getPanel=function(){return this.infoPanelDiv},n.prototype.destroy=function(e){var t,n;e?this.actionsLog=[]:this.actionsLog.push({destroy:J.now()}),this.infoPanelDiv.parentNode&&this.infoPanelDiv.parentNode.removeChild(this.infoPanelDiv),this.isVisible=!1,this.infoPanelDiv=null,t=-1,n=this._buttons.length;for(;++t<n;)this._buttons[t].parentNode&&this._buttons[t].parentNode.removeChild(this._buttons[t]);W.adjustHeaderOffset(!0)},n.prototype.toggle=function(){this.isVisible?this.close():this.open()},n.prototype.open=function(){if(this.isVisible)return;this.actionsLog.push({open:J.now()}),this.infoPanelDiv.style.display="block",this.isVisible=!0,W.adjustHeaderOffset(!0)},n.prototype.close=function(){if(!this.isVisible)return;this.actionsLog.push({close:J.now()}),this.infoPanelDiv.style.display="none",this.isVisible=!1,W.adjustHeaderOffset(!0)},n.prototype.createToggleButton=function(e){var t,n;e=e||"Toggle Info Panel";if("string"!=typeof e||e.trim()==="")throw new Error("InfoPanel.createToggleButton: buttonLabel must be undefined or a non-empty string. Found: "+e);return n=document.createElement("button"),n.className="btn btn-lg btn-warning",n.innerHTML=e,t=this,n.onclick=function(){t.toggle()},this._buttons.push(n),n}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(e,t){"use strict";var n=t.constants,r=t.GameWindow;r.prototype.getRecipientSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.addStandardRecipients(t),t},r.prototype.addRecipientSelector=function(e,t){var n;return e?(n=this.getRecipientSelector(t),e.appendChild(n)):!1},r.prototype.addStandardRecipients=function(e){var t;t=document.createElement("option"),t.value="ALL",t.appendChild(document.createTextNode("ALL")),e.appendChild(t),t=document.createElement("option"),t.value="CHANNEL",t.appendChild(document.createTextNode("CHANNEL")),e.appendChild(t),t=document.createElement("option"),t.value="ROOM",t.appendChild(document.createTextNode("ROOM")),e.appendChild(t),t=document.createElement("option"),t.value="SERVER",t.appendChild(document.createTextNode("SERVER")),e.appendChild(t)},r.prototype.populateRecipientSelector=function(e,t){var n,r;if("object"!=typeof t||"object"!=typeof e)return;this.removeChildrenFromNode(e),this.addStandardRecipients(e),n=t.db||t,J.each(n,function(t){r=document.createElement("option"),r.value=t.id,r.appendChild(document.createTextNode(t.name||t.id)),e.appendChild(r)})},r.prototype.getActionSelector=function(e){var t=document.createElement("select");return"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,n.action),t},r.prototype.addActionSelector=function(e,t){var n;if(!e)return;return n=this.getActionSelector(t),e.appendChild(n)},r.prototype.getTargetSelector=function(e){var t;return t=document.createElement("select"),"undefined"!=typeof e&&(t.id=e),this.populateSelect(t,n.target),t},r.prototype.addTargetSelector=function(e,t){if(!e)return;var n=this.getTargetSelector(t);return e.appendChild(n)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){"use strict";function i(e,t){var n,r,i,s,o,u;t=t||document,n=["button","select","textarea","input"],i=n.length;for(r=0;r<i;r++){o=t.getElementsByTagName(n[r]),u=o.length;for(s=0;s<u;s++)"undefined"==typeof e&&(e=o[s].disabled?!1:!0),e?o[s].disabled=e:o[s].removeAttribute("disabled")}}function s(e,t){var n;if("string"==typeof e)n=W.getElementById(e);else{if(!J.isElement(e))throw new TypeError(t+": idOrObj must be string "+" or HTML Element. Found: "+e);n=e}return n}var n=t.GameWindow,r=J.require("DOM");n.prototype.getScreen=function(){var e;return e=this.getFrameDocument(),e?e=e.body||e:e=document.body||document.lastElementChild,e},n.prototype.write=function(e,t){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.write: could not determine where to write.");return r.write(t,e)},n.prototype.writeln=function(e,t,n){"string"==typeof t?t=this.getElementById(t):t||(t=this.getScreen());if(!t)throw new Error("GameWindow.writeln: could not determine where to write.");return r.writeln(t,e,n)},n.prototype.generateUniqueId=function(e){var t,n;t=""+(e||J.randomInt(0,1e3)),n=this.getElementById(t);while(n)t=""+e+"_"+J.randomInt(0,1e3),n=this.getElementById(t);return t},n.prototype.toggleInputs=function(e,n){var r;if(!document.getElementsByTagName)return t.err("GameWindow.toggleInputs: getElementsByTagName not found."),!1;if(e&&"string"==typeof e)throw new Error("GameWindow.toggleInputs: id must be string or undefined.");if(e){r=this.getElementById(e);if(!r)throw new Error("GameWindow.toggleInputs: no elements found with id "+e+".");i(n,r)}else i(n),r=this.getFrameDocument(),r&&i(n,r);return!0},n.prototype.getLoadingDots=function(e,t){function o(){n.innerHTML=".",clearInterval(s)}var n,r,i,s;if(e&e<0)throw new Error("GameWindow.getLoadingDots: len cannot be < 0. Found: "+e);e=e||5,n=document.createElement("span"),n.id=t||"span_dots",i="";for(r=0;r<e;r++)i+=".";return s=setInterval(function(){n.innerHTML!==i?n.innerHTML=n.innerHTML+".":n.innerHTML="."},1e3),{span:n,stop:o}},n.prototype.addLoadingDots=function(e,t,n){var r;return r=this.getLoadingDots(t,n),e.appendChild(r.span),r},n.prototype.getEventButton=function(e,n){var r;if("string"!=typeof e)throw new TypeError("GameWindow.getEventButton: event must be string. Found: "+e);return"string"==typeof n?n={innerHTML:n}:n||(n={}),n.innerHTML||(n.innerHTML=e),r=this.get("button",n),r.onclick=function(){t.emit(e)},r},n.prototype.addEventButton=function(e,t,n){var r;return r=this.getEventButton(e,n),t||(t=this.getScreen()),t.appendChild(r)},n.prototype.searchReplace=function(){var e,t,n,r,i,s;arguments.length===2?(t="g",n=arguments[1]):arguments.length>2&&(t=arguments[1],n=arguments[2]);if("undefined"==typeof n)n="ng_replace_";else if(null===n)n="";else if("string"!=typeof n)throw new TypeError("GameWindow.searchReplace: prefix must be string, null or undefined. Found: "+n);e=arguments[0];if(J.isArray(e)){s=-1,i=e.length;for(;++s<i;)this.setInnerHTML(n+e[s].search,e[s].replace,e[s].mod||t)}else{if("object"==typeof e)throw new TypeError("GameWindow.setInnerHTML: elements must be object or arrray. Found: "+e);for(r in e)e.hasOwnProperty(r)&&this.setInnerHTML(n+r,e[r],t)}},n.prototype.setInnerHTML=function(e,t,n){var r,i,s;if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("GameWindow.setInnerHTML: search must be string or number. Found: "+e);if("string"!=typeof t&&"number"!=typeof t)throw new TypeError("GameWindow.setInnerHTML: replace must be string or number. Found: "+t);if("undefined"==typeof n)n="id";else{if("string"!=typeof n)throw new TypeError("GameWindow.setInnerHTML: mod must be string or undefined. Found: "+n);if(n!=="g"&&n!=="id"&&n!=="className")throw new Error("GameWindow.setInnerHTML: invalid mod value: "+n)}if(n==="id"||n==="g")r=W.getElementById(e),r&&r.className!==e&&(r.innerHTML=t);if(n==="className"||n==="g"){r=W.getElementsByClassName(e),s=r.length;if(s){i=-1;for(;++i<s;)r[i].innerHTML=t}}},n.prototype.hide=function(e){var t;return t=s(e,"GameWindow.hide"),t&&(t.style.display="none"),t},n.prototype.show=function(e,t){var n;t=t||"";if("string"!=typeof t)throw new TypeError("GameWindow.show: display must be string or undefined");return n=s(e,"GameWindow.show"),n&&(n.style.display=t),n},n.prototype.toggle=function(e,t){var n;n=s(e,"GameWindow.toggle");if(n)if(n.style.display==="none"){t=t||"";if("string"!=typeof t)throw new TypeError("GameWindow.toggle: display must be string or undefined");n.style.display=t}else n.style.display="none";return n}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(){"use strict";node.window=new node.GameWindow,"undefined"!=typeof window&&(window.W=node.window)}(),function(e){"use strict";function t(e){this.canvas=e,this.ctx=e.getContext("2d"),this.centerX=e.width/2,this.centerY=e.height/2,this.width=e.width,this.height=e.height}e.Canvas=t,t.prototype={constructor:t,drawOval:function(e){var t=e.x/e.scale_x,n=e.y/e.scale_y,r=e.radius||100;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.scale(e.scale_x,e.scale_y),this.ctx.beginPath(),this.ctx.arc(t,n,r,0,Math.PI*2,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(e){var t=e.x,n=e.y,r=e.length,i=e.angle,s=-Math.cos(i)*r+e.x,o=Math.sin(i)*r+e.y;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(s,o),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(e,t){this.ctx.scale(e,t),this.centerX=this.canvas.width/2/e,this.centerY=this.canvas.height/2/t},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var e=this.canvas.width;this.canvas.width=1,this.canvas.width=e}}}(node.window),function(e,t,n){"use strict";function s(e){this.options=e||{},this.tm=new i,this.init(this.options)}function o(e){e=e||{},this.content="undefined"!=typeof e.content?e.content:"";if("string"==typeof e.id)this.id=e.id;else if("undefined"!=typeof e.id)throw new TypeError("Entity: id must be string or undefined.");if("string"==typeof e.className)this.className=e.className;else if(J.isArray(e.className))this.className=e.join(" ");else if("undefined"!=typeof e.className)throw new TypeError("Entity: className must be string, array, or undefined.")}var r=t.document,i=n.TriggerManager;if(!i)throw new Error("HTMLRenderer requires node.TriggerManager to load.");e.HTMLRenderer=s,e.HTMLRenderer.Entity=o,s.prototype.init=function(e){e=e||this.options,this.options=e,this.reset(),e.returnAt&&(this.tm.returnAt=e.returnAt),e.pipeline&&this.tm.initTriggers(e.pipeline)},s.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},s.prototype.addDefaultPipeline=function(){this.tm.addTrigger(function(e){return r.createTextNode(e.content)}),this.tm.addTrigger(function(e){var t,n,i;if(!e)return;if(e.content&&"object"==typeof e.content){t=r.createElement("div");for(n in e.content)e.content.hasOwnProperty(n)&&(i=n+":	"+e.content[n],t.appendChild(r.createTextNode(i)),t.appendChild(r.createElement("br")));return t}}),this.tm.addTrigger(function(e){var t;if(!e)return;if(e.content&&e.content.parse&&"function"==typeof e.content.parse){t=e.content.parse();if(J.isElement(t)||J.isNode(t))return t}}),this.tm.addTrigger(function(e){if(!e)return;if(J.isElement(e.content)||J.isNode(e.content))return e.content})},s.prototype.clear=function(e){return this.tm.clear(e)},s.prototype.addRenderer=function(e,t){return this.tm.addTrigger(e,t)},s.prototype.removeRenderer=function(e){return this.tm.removeTrigger(e)},s.prototype.render=function(e){return this.tm.pullTriggers(e)},s.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e,t){"use strict";function s(e,t){e=e||{},this.options=e,n.call(this,e,t),this.id=e.id||"list_"+Math.round(Math.random()*1e3),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function o(e){i.call(this,e),this.dt="undefined"!=typeof e.dt?e.dt:null,"undefined"!=typeof e.dd&&(this.dd=e.dd)}var n=t.NDDB,r=t.window.HTMLRenderer,i=t.window.HTMLRenderer.Entity;e.List=s,s.prototype=new n,s.prototype.constructor=s,s.prototype.init=function(e){e=e||this.options,this.FIRST_LEVEL=e.first_level||"dl",this.SECOND_LEVEL=e.second_level||"dt",this.THIRD_LEVEL=e.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:this.auto_update;var t=this.lifo="undefined"!=typeof e.lifo?e.lifo:this.lifo;this.globalCompare=function(e,n){if(!e&&!n)return 0;if(!n)return 1;if(!e)return-1;if(!t){if(e.dt<n.dt)return-1;if(e.dt>n.dt)return 1}else{if(e.dt<n.dt)return 1;if(e.dt>n.dt)return-1}if(e.dt===n.dt){if("undefined"==typeof e.dd)return-1;if("undefined"==typeof n.dd)return 1;if(e.dd<n.dd)return-1;if(e.dd>n.dd)return 1;if(e.nddbid<n.nddbid)return 1;if(e.nddbid>n.nddbid)return-1}return 0},this.DL=e.list||document.createElement(this.FIRST_LEVEL),this.DL.id=e.id||this.id,e.className&&(this.DL.className=e.className),this.options.title&&this.DL.appendChild(document.createTextNode(e.title)),this.htmlRenderer=new r(e.render)},s.prototype._add=function(e){if(!e)return;this.insert(e),this.auto_update&&this.parse()},s.prototype.addDT=function(e,t){if("undefined"==typeof e)return;this.last_dt++,t="undefined"!=typeof t?t:this.last_dt,this.last_dd=0;var n=new o({dt:t,content:e});return this._add(n)},s.prototype.addDD=function(e,t,n){if("undefined"==typeof e)return;t="undefined"!=typeof t?t:this.last_dt,n="undefined"!=typeof n?n:this.last_dd++;var r=new o({dt:t,dd:n,content:e});return this._add(r)},s.prototype.parse=function(){this.sort();var e=null,t=null,n=function(){var n=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(n),t=null,e=n,n},r=function(){var e=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(e),e};if(this.DL){while(this.DL.hasChildNodes())this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var s=this.db[i],o;"undefined"==typeof s.dd?o=n.call(this):o=r.call(this);var u=this.htmlRenderer.render(s);o.appendChild(u)}return this.DL},s.prototype.getRoot=function(){return this.DL},o.prototype=new i,o.prototype.constructor=o}("undefined"!=typeof node?"undefined"!=typeof node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){"use strict";function u(e,t){e=e||{},e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),i.call(this,e,t),this.rowcol||this.index("rowcol",function(e){return e.x+"."+e.y}),this.pointers={x:e.pointerX||null,y:e.pointerY||null},this.header=[],this.footer=[],this.left=[],this.table=e.table||r.createElement("table");if("string"==typeof e.id)this.table.id=e.id;else if(e.id)throw new TypeError("Table constructor: options.id must be string or undefined.");if("string"==typeof e.className)this.table.className=e.className;else if(J.isArray(e.className))this.table.className=e.className.join(" ");else if(e.className)throw new TypeError("Table constructor: options.className must be string, array, or undefined.");this.missingClassName="missing";if("string"==typeof e.missingClassName)this.missingClassName=e.missingClassName;else if(J.isArray(e.missingClassName))this.missingClassName=e.missingClassName.join(" ");else if(e.missingClassName)throw new TypeError("Table constructor: options.className must be string, array, or undefined.");this.autoParse="undefined"!=typeof e.autoParse?e.autoParse:!1,this.trs={};if("function"==typeof e.tr)this.trCb=e.tr;else{if("undefined"!=typeof e.tr)throw new TypeError("Table constructor: options.tr must be function or undefined.");this.trCb=null}this.initRenderer(e.render)}function a(e,t,n,r){var i,s;if("undefined"!=typeof t){if("number"!=typeof t||t<0)throw new TypeError("Table."+e+": x must be "+"a non-negative number or undefined.");i=!0}if("undefined"!=typeof n){if("number"!=typeof n||n<0)throw new TypeError("Table."+e+": y must be "+"a non-negative number or undefined.");s=!0}if(r==="either"&&i&&s)throw new Error("Table."+e+": either x OR y can "+"be defined.");if(r==="both"&&(!i||!s))throw new Error("Table."+e+": both x AND y must "+"be defined.");if(r==="any"&&!i&&!s)throw new Error("Table."+e+": either x or y must "+"be defined.");if(r==="x"&&!i)throw new Error("Table."+e+": x must be defined.");if(r==="y"&&!s)throw new Error("Table."+e+": y be defined.")}function f(e,t,n,r,i){a(e,n,r);if(i&&!J.isArray(t))throw new TypeError("Table."+e+": data must be array.")}function l(e){var t,n,r;t=[],n=-1,r=e.length;for(;++n<r;)t.push({content:e[n]});return t}function c(e){o.call(this,e),this.x="undefined"!=typeof e.x?e.x:null,this.y="undefined"!=typeof e.y?e.y:null,this.HTMLElement=e.HTMLElement||null}var r=t.document;e.Table=u,e.Table.Cell=c;var i=n.NDDB,s=n.window.HTMLRenderer,o=n.window.HTMLRenderer.Entity;u.prototype=new i,u.prototype.constructor=u,u.cell=function(e){return new c(e)},u.prototype.initRenderer=function(e){e=e||{},this.htmlRenderer=new s(e),this.htmlRenderer.addRenderer(function(e){var t,n;if(e.content&&"object"==typeof e.content){t=new u;for(n in e.content)e.content.hasOwnProperty(n)&&t.addRow([n,e.content[n]]);return t.parse()}},2)},u.prototype.renderCell=function(e,t){var n,i;if(!e)return;return t=t||"td",n=r.createElement(t),i=this.htmlRenderer.render(e),n.appendChild(i),e.className&&(n.className=e.className),e.id&&(n.id=e.id),e.HTMLElement=n,n},u.prototype.get=function(e,t){return a("get",e,t,"any"),"undefined"==typeof e?this.select("y","=",t):"undefined"==typeof t?this.select("x","=",e):this.rowcol.get(e+"."+t)},u.prototype.getTR=function(e){return e!=="thead"&&e!=="tfoot"&&a("getTR",e,undefined,"x"),this.trs[e]||!1},u.prototype.setHeader=function(e){f("setHeader",e,undefined,undefined,!0),this.header=l(e)},u.prototype.setLeft=function(e){f("setLeft",e,undefined,undefined,!0),this.left=l(e)},u.prototype.setFooter=function(e){f("setFooter",e,undefined,undefined,!0),this.footer=l(e)},u.prototype.updatePointer=function(e,t){if("undefined"==typeof this.pointers[e])throw new Error("Table.updatePointer: invalid pointer: "+e);if(this.pointers[e]===null||t>this.pointers[e])this.pointers[e]=t;return this.pointers[e]},u.prototype.addMultiple=function(e,t,n,r){var i,s,o,u;f("addMultiple",e,n,r);if(t&&"string"!=typeof t||t&&"undefined"==typeof this.pointers[t])throw new TypeError("Table.addMultiple: dim must be a valid dimension (x or y) or undefined.");t=t||"x",n=this.getCurrPointer("x",n),r=this.getNextPointer("y",r),n="undefined"!=typeof n?n:this.pointers.x===null?0:this.pointers.x,r="undefined"!=typeof r?r:this.pointers.y===null?0:this.pointers.y,J.isArray(e)||(e=[e]),i=-1,s=e.length;for(;++i<s;)if(!J.isArray(e[i]))t==="x"?this.add(e[i],n,r+i,"x"):this.add(e[i],n+i,r,"y");else{o=-1,u=e[i].length;for(;++o<u;)t==="x"?this.add(e[i][o],n+i,r+o,"x"):this.add(e[i][o],n+o,r+i,"y")}this.autoParse&&this.parse()},u.prototype.add=function(e,t,n,r){var i;f("add",e,t,n);if(r&&"string"!=typeof r||r&&"undefined"==typeof this.pointers[r])throw new TypeError("Table.add: dim must be a valid string (x, y) or undefined.");r=r||"x",t=r==="y"?this.getCurrPointer("x",t):this.getNextPointer("x",t),n=r==="y"?this.getNextPointer("y",n):this.getCurrPointer("y",n),e&&"object"==typeof e&&"undefined"!=typeof e.content?("undefined"==typeof e.x&&(e.x=t),"undefined"==typeof e.y&&(e.y=n),i=new c(e)):i=new c({x:t,y:n,content:e}),this.insert(i),this.updatePointer("x",t),this.updatePointer("y",n)},u.prototype.addColumn=function(e,t,n){return f("addColumn",e,t,n),this.addMultiple(e,"y",t||0,this.getNextPointer("y",n))},u.prototype.addRow=function(e,t,n){return f("addRow",e,t,n),this.addMultiple(e,"x",this.getNextPointer("x",t),n||0)},u.prototype.getNextPointer=function(e,t){return"undefined"!=typeof t?t:this.pointers[e]===null?0:this.pointers[e]+1},u.prototype.getCurrPointer=function(e,t){return"undefined"!=typeof t?t:this.pointers[e]===null?0:this.pointers[e]},u.prototype.parse=function(){var e,t,n,i,s,o,u,a,f,l,c,h,p,d;this.table&&this.table.children&&(this.table.innerHTML=""),e=this.table;if(this.header&&this.header.length){i=r.createElement("thead"),t=r.createElement("tr"),this.trCb&&this.trCb(t,"thead"),this.trs.thead=t,this.left&&this.left.length&&t.appendChild(r.createElement("th")),u=-1,f=this.header.length;for(;++u<f;)t.appendChild(this.renderCell(this.header[u],"th"));i.appendChild(t),e.appendChild(i)}if(this.size()){s=r.createElement("tbody"),this.sort(["x","y"]),l=-1,c=this.first(),h=c.y,p=0,u=-1,f=this.db.length;for(;++u<f;){l!==this.db[u].x&&(t=r.createElement("tr"),this.trCb&&this.trCb(t,l+1),this.trs[l+1]=t,s.appendChild(t),l=this.db[u].x,h=c.y-1,this.left&&this.left.length&&(n=r.createElement("td"),t.appendChild(this.renderCell(this.left[p])),p++));if(this.db[u].y>h+1){d=this.db[u].y-(h+1);for(a=0;a<d;a++)n=r.createElement("td"),n.className=this.missingClassName,t.appendChild(n)}t.appendChild(this.renderCell(this.db[u])),h=this.db[u].y}e.appendChild(s)}if(this.footer&&this.footer.length){o=r.createElement("tfoot"),t=r.createElement("tr"),this.trCb&&this.trCb(t,"tfoot"),this.trs.tfoot=t,this.header&&this.header.length&&(n=r.createElement("td"),t.appendChild(n)),u=-1,f=this.footer.length;for(;++u<f;)t.appendChild(this.renderCell(this.footer[u]));o.appendChild(t),e.appendChild(o)}return e},u.prototype.resetPointers=function(e){if(e&&"object"!=typeof e)throw new TypeError("Table.resetPointers: pointers must be object or undefined.");e=e||{},this.pointers={x:e.pointerX||0,y:e.pointerY||0}},u.prototype.addClass=function(e,t,n){var r;if(J.isArray(e))e=e.join(" ");else if("string"!=typeof e)throw new TypeError("Table.addClass: className must be string or array.");a("addClass",t,n),r=this;if("undefined"!=typeof t||"undefined"!=typeof n)"undefined"!=typeof t&&(r=r.select("x","=",t)),"undefined"!=typeof n&&(r=r.and("y","=",n));return r.each(function(t){W.addClass(t,e),t.HTMLElement&&(t.HTMLElement.className=t.className)}),this},u.prototype.removeClass=function(e,t,n){var r,i;if(J.isArray(e))r=function(e,t){for(var n=0;n<t.length;n++)W.removeClass(e,t[n])};else if("string"==typeof e)r=W.removeClass;else{if(null!==e)throw new TypeError("Table.removeClass: className must be string, array, or null.");r=function(e){e.className=""}}a("removeClass",t,n),i=this;if("undefined"!=typeof t||"undefined"!=typeof n)"undefined"!=typeof t&&(i=i.select("x","=",t)),"undefined"!=typeof n&&(i=i.and("y","=",n));return i.each(function(t){r.call(this,t,e),t.HTMLElement&&(t.HTMLElement.className=t.className)}),this},u.prototype.clear=function(){i.prototype.clear.call(this,!0),this.resetPointers()},c.prototype=new o,c.prototype.constructor=c}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node)