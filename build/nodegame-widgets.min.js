/**
 * # Widget
 * Copyright(c) 2016 Stefano Balietti
 * MIT Licensed
 *
 * Prototype of a widget class
 *
 * Prototype methods will be injected in every new widget, if missing.
 *
 * Additional properties can be automatically, depending on configuration.
 *
 * @see Widgets.get
 * @see Widgets.append
 */
(function(e){"use strict";function n(){}var t=e.JSUS;e.Widget=n,n.prototype.init=function(e){},n.prototype.listeners=function(){},n.prototype.append=function(){},n.prototype.getValues=function(e){},n.prototype.setValues=function(e){},n.prototype.reset=function(e){},n.prototype.highlight=function(e){},n.prototype.unhighlight=function(){},n.prototype.isHighlighted=function(){return!!this.highlighted},n.prototype.enable=function(){},n.prototype.disable=function(){},n.prototype.isDisabled=function(){return!!this.disabled},n.prototype.hide=function(){if(!this.panelDiv)return;this.panelDiv.style.display="none"},n.prototype.show=function(e){this.panelDiv&&this.panelDiv.style.display==="none"&&(this.panelDiv.style.display=e||"")},n.prototype.toggle=function(e){if(!this.panelDiv)return;this.panelDiv.style.display==="none"?this.panelDiv.style.display=e||"":this.panelDiv.style.display="none"},n.prototype.destroy=null,n.prototype.setTitle=function(e){var n;if(!this.panelDiv)throw new Error("Widget.setTitle: panelDiv is missing.");if(!e)this.headingDiv&&(this.panelDiv.removeChild(this.headingDiv),this.headingDiv=null);else{this.headingDiv||(this.headingDiv=W.addDiv(this.panelDiv,undefined,{className:"panel-heading"}),n=this.bodyDiv&&this.bodyDiv.childNodes[0]||null,this.panelDiv.insertBefore(this.headingDiv,n));if(W.isElement(e))this.headingDiv.innerHTML="",this.headingDiv.appendChild(e);else{if("string"!=typeof e)throw new TypeError(t.funcName(this)+".setTitle: "+"title must be string, HTML element or "+"falsy. Found: "+e);this.headingDiv.innerHTML=e}}},n.prototype.setFooter=function(e){if(!this.panelDiv)throw new Error("Widget.setFooter: panelDiv is missing.");if(!e)this.footerDiv&&(this.panelDiv.removeChild(this.footerDiv),delete this.footerDiv);else{this.footerDiv||(this.footerDiv=W.addDiv(this.panelDiv,undefined,{className:"panel-footer"}));if(W.isElement(e))this.footerDiv.innerHTML="",this.footerDiv.appendChild(e);else{if("string"!=typeof e)throw new TypeError(t.funcName(this)+".setFooter: "+"footer must be string, HTML element or "+"falsy. Found: "+title);this.footerDiv.innerHTML=e}}},n.prototype.setContext=function(e){if("string"!=typeof e)throw new TypeError(t.funcName(this)+".setContext: "+"footer must be string. Found: "+e);W.removeClass(this.panelDiv,"panel-[a-z]*"),W.addClass(this.panelDiv,"panel-"+e)}})("undefined"!=typeof node?node:module.parent.exports.node),function(e,t){"use strict";function r(){var e;this.widgets={},this.instances=[],this.lastAppended=null,e=this,t.registerSetup("widgets",function(n){var r,i;if(!n)return;if(n.widgets)for(r in n.widgets)n.widgets.hasOwnProperty(r)&&e.register(r,n.widgets[r]);n.destroyAll&&e.destroyAll();if(n.append)for(r in n.append)n.append.hasOwnProperty(r)&&("string"==typeof n.append[r].root&&(i=W.getElementById(n.append[r].root)),i||(i=W.getScreen()),i?e.append(r,i,n.append[r]):t.warn("setup widgets: could not find a root for widget "+r+"."));return n}),t.info("node-widgets: loading.")}function i(e,t){return W.addDiv(e,undefined,t.attributes)}function s(e,n){var r=e.name||e.id;t.err(n+" not found. "+r+" cannot be loaded.")}var n=t.JSUS;r.prototype.register=function(e,r){if("string"!=typeof e)throw new TypeError("Widgets.register: name must be string. Found: "+e);if("function"!=typeof r)throw new TypeError("Widgets.register: w must be function.Found: "+r);return n.mixout(r.prototype,new t.Widget),this.widgets[e]=r,this.widgets[e]},r.prototype.get=function(e,r){var i,s,o,u,a;if("string"!=typeof e)throw new TypeError("Widgets.get: widgetName must be string.Found: "+e);if(r&&"object"!=typeof r)throw new TypeError("Widgets.get: options must be object or undefined. Found: "+r);r=r||{},a=this,i=n.getNestedValue(e,this.widgets);if(!i)throw new Error("Widgets.get: "+e+" not found.");t.info("creating widget "+e+" v."+i.version);if(!this.checkDependencies(i))throw new Error("Widgets.get: "+e+" has unmet "+"dependencies.");i.defaults&&n.mixout(r,n.clone(i.defaults)),s=new i(r);if("undefined"!=typeof r.id){"number"==typeof r.id&&(r.id=""+r.id);if("string"!=typeof r.id)throw new TypeError("Widgets.get: options.id must be string, number or undefined. Found: "+r.id);s.id=r.id}return s.title="undefined"==typeof r.title?i.title:r.title,s.footer="undefined"==typeof r.footer?i.footer:r.footer,s.className="undefined"==typeof r.className?i.className:r.className,s.context="undefined"==typeof r.context?i.context:r.context,s.wid=""+n.randomInt(0,1e19),s.disabled=null,s.highlighted=null,s.init(r),r.listeners!==!1&&(t.events.setRecordChanges(!0),s.listeners.call(s),o=t.events.getChanges(!0),t.events.setRecordChanges(!1)),u=s.destroy,s.destroy=function(){var n,r,i,a;try{"function"==typeof u&&u.call(s),s.panelDiv&&s.panelDiv.parentNode&&s.panelDiv.parentNode.removeChild(s.panelDiv)}catch(f){t.warn(e+".destroy: error caught. "+f+".")}if(o)for(a in o)if(o.hasOwnProperty(a)){i=o[a],n=-1,r=i.added.length;for(;++n<r;)t.events.ee[a].off(i.added[n].type,i.added[n].listener);n=-1,r=o[a].removed.length;for(;++n<r;)t.events.ee[a].on(i.removed[n].type,i.removed[n].listener)}n=-1,r=t.widgets.instances.length;for(;++n<r;)if(t.widgets.instances[n].wid===s.wid){t.widgets.instances.splice(n,1);break}},this.instances.push(s),s},r.prototype.append=function(e,t,r){if("string"!=typeof e&&"object"!=typeof e)throw new TypeError("Widgets.append: w must be string or object. Found: "+e);if(t&&!n.isElement(t))throw new TypeError("Widgets.append: root must be HTMLElement or undefined. Found: "+t);if(r&&"object"!=typeof r)throw new TypeError("Widgets.append: options must be object or undefined. Found: "+r);return t||(t=W.getFrameDocument(),t&&(t=t.body),t||(t=document.body)),r=r||{},"string"==typeof e&&(e=this.get(e,r)),e.panelDiv=i(t,{attributes:{className:["ng_widget","panel","panel-default",e.className]}}),e.title&&e.setTitle(e.title),e.bodyDiv=i(e.panelDiv,{attributes:{className:"panel-body"}}),e.footer&&e.setFooter(e.footer),e.context&&e.setContext(e.context),e.append(),this.lastAppended=e,e},r.prototype.add=function(e,t,n){return console.log("***Widgets.add is deprecated. Use Widgets.append instead.***"),this.append(e,t,n)},r.prototype.isWidget=function(e,n){return n?e instanceof t.Widget:"object"==typeof e&&"function"==typeof e.append&&"function"==typeof e.getValues},r.prototype.destroy=function(e){var n,r;if("string"!=typeof e||!e.trim().length)throw new TypeError("Widgets.destroy: id must be a non-empty string. Found: "+e);n=-1,r=this.instances.length;for(;++n<r;)if(this.instances[n].id===e)return this.instances[n].destroy(),!0;return t.warn("node.widgets.destroy: widget could not be destroyed: "+e),!1},r.prototype.destroyAll=function(){var e,n;e=-1,n=this.instances.length;for(;++e<n;)this.instances[0].destroy();this.instances.length&&t.warn("node.widgets.destroyAll: some widgets could not be destroyed.")},r.prototype.checkDependencies=function(r,i){var o,u,a,f,l;if(!r.dependencies)return!0;o=[e,t,this.widgets,t.window],u=r.dependencies;for(a in u)if(u.hasOwnProperty(a)){f=!1;for(l=0;l<o.length;l++)if(n.getNestedValue(a,o[l])){f=!0;break}if(!f)return i||s(r,a),!1}return!0},t.widgets=new r}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){"use strict";function n(){this.mode=null,this.recipient=null,this.textarea=null,this.textareaId=null,this.chat=null,this.chatId=null,this.submit=null,this.submitId=null,this.submitText=null,this.chatEvent=null,this.displayName=null,this.recipient={value:null}}var t=e.JSUS;e.widgets.register("Chat",n),n.version="0.5.1",n.description="Offers a uni-/bi-directional communication interface between players, or between players and the experimenter.",n.title="Chat",n.className="chat",n.modes={MANY_TO_MANY:"MANY_TO_MANY",MANY_TO_ONE:"MANY_TO_ONE",ONE_TO_ONE:"ONE_TO_ONE",RECEIVER_ONLY:"RECEIVER_ONLY"},n.dependencies={JSUS:{}},n.prototype.init=function(e){var t;e=e||{};if("undefined"==typeof e.mode)e.mode="MANY_TO_MANY";else{if("string"!=typeof e.mode)throw new Error("Chat.init: options.mode must be string or undefined. Found: "+e.mode);switch(e.mode){case n.modes.RECEIVER_ONLY:t="SERVER";break;case n.modes.MANY_TO_ONE:t="ROOM";break;case n.modes.ONE_TO_ONE:t="SERVER";break;case n.modes.MANY_TO_MANY:break;default:throw new Error("Chat.init: options.mode is invalid: "+e.mode)}this.recipient.value=t}this.mode=e.mode,this.textareaId=e.textareaId||"chat_textarea",this.chatId=e.chatId||"chat_chat",this.submitId=e.submitId||"chat_submit",this.chatEvent=e.chatEvent||"CHAT",this.submitText=e.submitText||"chat",this.displayName=e.displayName||function(e){return e}},n.prototype.append=function(){this.chat=W.getElement("div",this.chatId),this.bodyDiv.appendChild(this.chat),this.mode!==n.modes.RECEIVER_ONLY&&(this.submit=W.getEventButton(this.chatEvent,this.submitText,this.submitId),this.submit.className="btn btn-sm btn-secondary",this.textarea=W.getElement("textarea",this.textareaId),W.writeln("",this.bodyDiv),this.bodyDiv.appendChild(this.textarea),W.writeln("",this.bodyDiv),this.bodyDiv.appendChild(this.submit),this.mode===n.modes.MANY_TO_MANY&&(this.recipient=W.getRecipientSelector(),this.bodyDiv.appendChild(this.recipient)))},n.prototype.readTA=function(){var e;return e=this.textarea.value,this.textarea.value="",e},n.prototype.writeTA=function(e,n){t.sprintf(e,n,this.chat),W.writeln("",this.chat),this.chat.scrollTop=this.chat.scrollHeight},n.prototype.listeners=function(){var t=this;e.on(this.chatEvent,function(){var n,r,i;n=t.readTA();if(!n)return;r=t.recipient.value,i={"%s":{"class":"chat_me"},"%msg":{"class":"chat_msg"},"!txt":n,"!to":r},t.writeTA("%sMe -> !to%s: %msg!txt%msg",i),e.say(t.chatEvent,r,n.trim())}),this.mode===n.modes.MANY_TO_MANY&&e.on("UPDATED_PLIST",function(){W.populateRecipientSelector(t.recipient,e.game.pl.fetch())}),e.on.data(this.chatEvent,function(r){var i,s;if(r.from===e.player.id||r.from===e.player.sid)return;if(this.mode===n.modes.ONE_TO_ONE&&r.from===this.recipient.value)return;i=t.displayName(r.from),s={"%s":{"class":"chat_others"},"%msg":{"class":"chat_msg"},"!txt":r.data,"!from":i},t.writeTA("%s!from%s: %msg!txt%msg",s)})}}(node),function(e){"use strict";function r(e){var t=this;this.options=null,this.table=null,this.sc=null,this.fp=null,this.canvas=null,this.changes=[],this.onChange=null,this.onChangeCb=function(e,n){"undefined"==typeof n&&(n=!1),e||(t.sc?e=t.sc.getValues():e=s.random()),t.draw(e,n)},this.timeFrom="step",this.features=null}function i(e,t){this.canvas=new W.Canvas(e),this.scaleX=e.width/r.width,this.scaleY=e.height/r.heigth,this.face=null}function s(e,t){var n;if("undefined"==typeof e)for(n in s.defaults)s.defaults.hasOwnProperty(n)&&(n==="color"?this.color="red":n==="lineWidth"?this.lineWidth=1:n==="scaleX"?this.scaleX=1:n==="scaleY"?this.scaleY=1:this[n]=s.defaults[n].min+Math.random()*s.defaults[n].range);else{if("object"!=typeof e)throw new TypeError("FaceVector constructor: faceVector must be object or undefined.");this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1,t=t||s.defaults;for(n in t)t.hasOwnProperty(n)&&(e.hasOwnProperty(n)?this[n]=e[n]:this[n]=t?t[n]:s.defaults[n].value)}}var t=e.JSUS,n=e.window.Table;e.widgets.register("ChernoffFaces",r),r.version="0.6.1",r.description="Display parametric data in the form of a Chernoff Face.",r.title="ChernoffFaces",r.className="chernofffaces",r.dependencies={JSUS:{},Table:{},Canvas:{},SliderControls:{}},r.FaceVector=s,r.FacePainter=i,r.width=100,r.height=100,r.onChange="CF_CHANGE",r.prototype.init=function(t){this.options=t,t.features?this.features=new s(t.features):this.features||(this.features=s.random()),this.fp&&this.fp.draw(this.features),t.onChange===!1||t.onChange===null?this.onChange&&(e.off(this.onChange,this.onChangeCb),this.onChange=null):(this.onChange="undefined"==typeof t.onChange?r.onChange:t.onChange,e.on(this.onChange,this.onChangeCb))},r.prototype.getCanvas=function(){return this.canvas},r.prototype.buildHTML=function(){var r,i,o,u;if(this.table)return;u=this.options,o={},this.id&&(o.id=this.id),"string"==typeof u.className?o.className=u.className:u.className!==!1&&(o.className="cf_table"),this.table=new n(o),this.canvas||this.buildCanvas();if("undefined"==typeof u.controls||u.controls)i=t.mergeOnKey(s.defaults,this.features,"value"),r={id:"cf_controls",features:i,onChange:this.onChange,submit:"Send"},"object"==typeof u.controls?this.sc=u.controls:this.sc=e.widgets.get("SliderControls",r);this.sc?this.table.addRow([{content:this.sc,id:this.id+"_td_controls"},{content:this.canvas,id:this.id+"_td_cf"}]):this.table.add({content:this.canvas,id:this.id+"_td_cf"}),this.table.parse()},r.prototype.buildCanvas=function(){var e;this.canvas||(e=this.options,e.canvas||(e.canvas={},"undefined"!=typeof e.height&&(e.canvas.height=e.height),"undefined"!=typeof e.width&&(e.canvas.width=e.width)),this.canvas=W.getCanvas("ChernoffFaces_canvas",e.canvas),this.fp=new i(this.canvas),this.fp.draw(this.features))},r.prototype.append=function(){this.table||this.buildHTML(),this.bodyDiv.appendChild(this.table.table)},r.prototype.draw=function(n,r){var i;if("object"!=typeof n)throw new TypeError("ChernoffFaces.draw: features must be object.");this.options.trackChanges&&("string"==typeof this.timeFrom?i=e.timer.getTimeSince(this.timeFrom):i=Date.now?Date.now():(new Date).getTime(),this.changes.push({time:i,change:n})),this.features=n instanceof s?n:new s(n,this.features),this.fp.redraw(this.features),this.sc&&r!==!1&&(this.sc.init({features:t.mergeOnKey(s.defaults,n,"value")}),this.sc.refresh())},r.prototype.getValues=function(e){return e&&e.changes?{changes:this.changes,cf:this.features}:this.fp.face},r.prototype.randomize=function(){var e;return e=s.random(),this.fp.redraw(e),this.sc&&(this.sc.init({features:t.mergeOnValue(s.defaults,e),onChange:this.onChange}),this.sc.refresh()),!0},i.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY),t=t||this.canvas.centerX,n=n||this.canvas.centerY,this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},i.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},i.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},i.prototype.fit2Canvas=function(e){var t;if(!this.canvas){console.log("No canvas found");return}this.canvas.width>this.canvas.height?t=this.canvas.width/e.head_radius*e.head_scale_x:t=this.canvas.height/e.head_radius*e.head_scale_y,e.scaleX=t/2,e.scaleY=t/2},i.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyes=function(e,t,n){var r=i.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawPupils=function(e,t,n){var r=e.pupil_radius,s=e.eye_spacing,o=i.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyebrow=function(e,t,n){var r=i.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:r,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:r,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawNose=function(e,t,n){var r=i.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=r+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,r),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},i.prototype.drawMouth=function(e,t,n){var r=i.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=r-e.mouth_top_y,a=r+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,u,o,r),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,a,o,r),this.canvas.ctx.stroke()},i.computeFaceOffset=function(e,t,n){n=n||0;var r=n-e.head_radius+e.head_radius*2*t;return r},i.computeEyebrowOffset=function(e,t){t=t||0;var n=2;return i.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},s.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"},scaleX:{min:0,max:20,step:.01,value:.2,label:"Scale X"},scaleY:{min:0,max:20,step:.01,value:.2,label:"Scale Y"},color:{min:0,max:20,step:.01,value:.2,label:"color"},lineWidth:{min:0,max:20,step:.01,value:.2,label:"lineWidth"}},function(e){var t;for(t in e)e.hasOwnProperty(t)&&(e[t].range=e[t].max-e[t].min)}(s.defaults),s.random=function(){return console.log("*** FaceVector.random is deprecated. Use new FaceVector() instead."),new s}}(node),function(e){"use strict";function n(n){this.options=n,this.id=n.id,this.table=new t({id:"cf_table"}),this.root=n.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.dims=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function r(t,r){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/n.defaults.canvas.width,this.scaleY=t.height/n.defaults.canvas.heigth}function i(e){e=e||{},this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=i.defaults[t].value)}var t=e.window.Table;e.widgets.register("ChernoffFacesSimple",n),n.defaults={},n.defaults.id="ChernoffFaces",n.defaults.canvas={},n.defaults.canvas.width=100,n.defaults.canvas.heigth=100,n.version="0.3",n.description="Display parametric data in the form of a Chernoff Face.",n.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},n.FaceVector=i,n.FacePainter=r,n.prototype.init=function(t){this.id=t.id||this.id;var s=this.id+"_";this.features=t.features||this.features||i.random(),this.controls="undefined"!=typeof t.controls?t.controls:!0;var o=t.idCanvas?t.idCanvas:s+"canvas";this.dims={width:t.width?t.width:n.defaults.canvas.width,height:t.height?t.height:n.defaults.canvas.heigth},this.canvas=e.window.getCanvas(o,this.dims),this.fp=new r(this.canvas),this.fp.draw(new i(this.features));var u={id:"cf_controls",features:JSUS.mergeOnKey(i.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",u),this.controls&&this.table.add(this.sc),"undefined"==typeof t.change?e.on(this.change,this.changeFunc):(t.change?e.on(t.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=t.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},n.prototype.getRoot=function(){return this.root},n.prototype.getCanvas=function(){return this.canvas},n.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},n.prototype.listeners=function(){},n.prototype.draw=function(e){if(!e)return;var t=new i(e);this.fp.redraw(t),this.sc.init({features:JSUS.mergeOnKey(i.defaults,e,"value")}),this.sc.refresh()},n.prototype.getAllValues=function(){return this.fp.face},n.prototype.randomize=function(){var e=i.random();this.fp.redraw(e);var t={features:JSUS.mergeOnKey(i.defaults,e,"value"),change:this.change};return this.sc.init(t),this.sc.refresh(),!0},r.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY);var t=t||this.canvas.centerX,n=n||this.canvas.centerY;this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},r.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},r.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},r.prototype.fit2Canvas=function(e){var t;if(!this.canvas){console.log("No canvas found");return}this.canvas.width>this.canvas.height?t=this.canvas.width/e.head_radius*e.head_scale_x:t=this.canvas.height/e.head_radius*e.head_scale_y,e.scaleX=t/2,e.scaleY=t/2},r.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyes=function(e,t,n){var i=r.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawPupils=function(e,t,n){var i=e.pupil_radius,s=e.eye_spacing,o=r.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyebrow=function(e,t,n){var i=r.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:i,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:i,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawNose=function(e,t,n){var i=r.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=i+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,i),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},r.prototype.drawMouth=function(e,t,n){var i=r.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=i-e.mouth_top_y,a=i+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,u,o,i),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,a,o,i),this.canvas.ctx.stroke()},r.computeFaceOffset=function(e,t,n){var n=n||0,r=n-e.head_radius+e.head_radius*2*t;return r},r.computeEyebrowOffset=function(e,t){var t=t||0,n=2;return r.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},i.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},i.random=function(){var e={};for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(JSUS.in_array(t,["color","lineWidth","scaleX","scaleY"])||(e[t]=i.defaults[t].min+Math.random()*i.defaults[t].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new i(e)},i.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&i.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=i.defaults[e].min+Math.random()*i.defaults[e].max)},i.prototype.distance=function(e){return i.distance(this,e)},i.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},i.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){"use strict";function n(){var e;e=this,this.dl=null,this.mainText=null,this.spanMainText=null,this.forms=null,this.order=null,this.shuffleForms=null,this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null}var t=e.JSUS;e.widgets.register("ChoiceManager",n),n.version="1.0.0",n.description="Groups together and manages a set of selectable choices forms (e.g. ChoiceTable).",n.title="Complete the forms below",n.className="choicemanager",n.dependencies={JSUS:{}},n.prototype.init=function(e){var t,n;n=this,"undefined"==typeof e.shuffleForms?t=!1:t=!!e.shuffleForms,this.shuffleForms=t;if("string"==typeof e.group||"number"==typeof e.group)this.group=e.group;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceManager.init: options.group must be string, number or undefined. Found: "+e.group);if("number"==typeof e.groupOrder)this.groupOrder=e.groupOrder;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceManager.init: options.groupOrder must be number or undefined. Found: "+e.groupOrder);if("string"==typeof e.mainText)this.mainText=e.mainText;else if("undefined"!=typeof e.mainText)throw new TypeError("ChoiceManager.init: options.mainText must be string, undefined. Found: "+e.mainText);this.freeText="string"==typeof e.freeText?e.freeText:!!e.freeText,"undefined"!=typeof e.forms&&this.setForms(e.forms)},n.prototype.setForms=function(n){var r,i,s,o;if("function"==typeof n){o=n.call(e.game);if(!t.isArray(o))throw new TypeError("ChoiceManager.setForms: forms is a callback, but did not returned an array. Found: "+o)}else{if(!t.isArray(n))throw new TypeError("ChoiceManager.setForms: forms must be array or function. Found: "+n);o=n}s=o.length;if(!s)throw new Error("ChoiceManager.setForms: forms is an empty array.");n=new Array(s),i=-1;for(;++i<s;){r=o[i];if(!e.widgets.isWidget(r)){"string"==typeof r.name&&(r=e.widgets.get(r.name,r));if(!e.widgets.isWidget(r))throw new Error("ChoiceManager.buildDl: one of the forms is not a widget-like element: "+o[i])}n[i]=r}this.forms=n,this.order=t.seq(0,s-1),this.shuffleForms&&(this.order=t.shuffle(this.order))},n.prototype.buildDl=function(){var t,n,r,i,s;t=-1,n=this.forms.length;for(;++t<n;)i=document.createElement("dt"),i.className="question",s=this.forms[this.order[t]],e.widgets.append(s,i),this.dl.appendChild(i)},n.prototype.append=function(){var e;if(W.getElementById(this.id))throw new Error("ChoiceManager.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=document.createElement("span"),this.spanMainText.className=n.className+"-maintext",this.spanMainText.innerHTML=this.mainText,this.bodyDiv.appendChild(this.spanMainText)),this.dl=document.createElement("dl"),this.buildDl(),this.bodyDiv.appendChild(this.dl),this.freeText&&(this.textarea=document.createElement("textarea"),this.textarea.id=this.id+"_text","string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),e=this.className?this.className+"-freetext":"freetext",this.textarea.className=e,this.bodyDiv.appendChild(this.textarea))},n.prototype.listeners=function(){var t=this;e.on("INPUT_DISABLE",function(){t.disable()}),e.on("INPUT_ENABLE",function(){t.enable()})},n.prototype.disable=function(){var e,t;if(this.disabled)return;e=-1,t=this.forms.length;for(;++e<t;)this.forms[e].disable()},n.prototype.enable=function(){var e,t;if(!this.disabled)return;e=-1,t=this.forms.length;for(;++e<t;)this.forms[e].disable()},n.prototype.verifyChoice=function(e){var t,n,r,i;r={id:this.id,order:this.order,forms:{}},e="undefined"==typeof e?!0:e,t=-1,n=this.forms.length;for(;++t<n;)i=this.forms[t],r.forms[i.id]=i.verifyChoice(e),r.form[i.id]||(r.fail=!0);return r},n.prototype.setCurrentChoice=function(e){var t,n;t=-1,n=this.forms[t].length;for(;++t<n;)this.forms[t].setCurrentChoice(e)},n.prototype.unsetCurrentChoice=function(e){var t,n;t=-1,n=this.forms[t].length;for(;++t<n;)this.forms[t].unsetCurrentChoice(e)},n.prototype.highlight=function(e){if(!this.dl)return;if(e&&"string"!=typeof e)throw new TypeError("ChoiceManager.highlight: border must be string or undefined. Found: "+e);this.dl.style.border=e||"3px solid red",this.highlighted=!0},n.prototype.unhighlight=function(){if(!this.dl)return;this.dl.style.border="",this.highlighted=!1},n.prototype.getValues=function(e){var t,n,r,i;t={id:this.id,order:this.order,forms:{},missValues:[]},e=e||{},e.markAttempt&&(t.isCorrect=!0),e=e||{},n=-1,r=this.forms.length;for(;++n<r;)i=this.forms[n],t.forms[i.id]=i.getValues(e),t.forms[i.id].choice===null&&t.missValues.push(i.id),e.markAttempt&&!t.forms[i.id].isCorrect&&(t.isCorrect=!1);return this.textarea&&(t.freetext=this.textarea.value),t},n.prototype.setValues=function(e){var n,r;if(!this.forms||!this.forms.length)throw new Error("ChoiceManager.setValues: no forms found.");e=e||{},n=-1,r=this.forms.length;for(;++n<r;)this.forms[n].setValues(e);this.textarea&&(this.textarea.value=t.randomString(100,"!Aa0"))}}(node),function(e){"use strict";function n(r){var i;i=this,this.table=null,this.trs=[],this.listener=function(n){var r,s,o,u;"string"==typeof i.timeFrom?i.timeCurrentChoice=e.timer.getTimeSince(i.timeFrom):i.timeCurrentChoice=Date.now?Date.now():(new Date).getTime(),n=n||window.event,o=n.target||n.srcElement;if("undefined"==typeof i.choicesIds[o.id])return;s=o.id.split(i.separator);if(s.length===1)return;r=s[0],s=s[1],i.numberOfClicks++,i.selectMultiple||(u=i.selected,u&&t.removeClass(u,"selected"),i.isChoiceCurrent(s)?i.unsetCurrentChoice(s):(i.currentChoice=s,t.addClass(o,"selected"),i.selected=o)),i.isHighlighted()&&i.unhighlight()},this.mainText=null,this.spanMainText=null,this.choices=null,this.choicesValues={},this.choicesIds={},this.choicesCells=null,this.left=null,this.leftCell=null,this.right=null,this.rightCell=null,this.timeCurrentChoice=null,this.timeFrom="step",this.order=null,this.correctChoice=null,this.requiredChoice=null,this.attempts=[],this.numberOfClicks=0,this.selected=null,this.currentChoice=null,this.selectMultiple=null,this.shuffleChoices=null,this.renderer=null,this.orientation="H",this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null,this.separator=n.separator}function r(e,t){"number"==typeof t&&(t=""+t);if("string"!=typeof t)throw new TypeError("ChoiceTable.setCorrectChoice: each choice must be number or string. Found: "+t);if("undefined"==typeof e.choicesValues[t])throw new TypeError("ChoiceTable.setCorrectChoice: choice not found: "+t);return t}function i(e,t){var n;return n=document.createElement("tr"),n.id="tr"+e.separator+e.id,e.table.appendChild(n),e.trs.push(n),n}var t=e.JSUS;e.widgets.register("ChoiceTable",n),n.version="1.2.0",n.description="Creates a configurable table where each cell is a selectable choice.",n.title="Make your choice",n.className="choicetable",n.separator="::",n.dependencies={JSUS:{}},n.prototype.init=function(e){var r,i;i=this;if(!this.id)throw new TypeError("ChoiceTable.init: options.id is missing.");if("undefined"==typeof e.orientation)r="H";else{if("string"!=typeof e.orientation)throw new TypeError("ChoiceTable.init: options.orientation must be string, or undefined. Found: "+e.orientation);r=e.orientation.toLowerCase().trim();if(r==="horizontal"||r==="h")r="H";else{if(r!=="vertical"&&r!=="v")throw new Error("ChoiceTable.init: options.orientation is invalid: "+r);r="V"}}this.orientation=r,"undefined"==typeof e.shuffleChoices?r=!1:r=!!e.shuffleChoices,this.shuffleChoices=r,"undefined"==typeof e.selectMultiple?r=!1:r=!!e.selectMultiple,this.selectMultiple=r;if("number"==typeof e.requiredChoice)this.requiredChoice=e.requiredChoice;else if("boolean"==typeof e.requiredChoice)this.requiredChoice=e.requiredChoice?1:0;else if("undefined"!=typeof e.requiredChoice)throw new TypeError("ChoiceTable.init: options.requiredChoice be number or boolean or undefined. Found: "+e.requiredChoice);if("string"==typeof e.group||"number"==typeof e.group)this.group=e.group;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceTable.init: options.group must be string, number or undefined. Found: "+e.group);if("number"==typeof e.groupOrder)this.groupOrder=e.groupOrder;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceTable.init: options.groupOrder must be number or undefined. Found: "+e.groupOrder);if("function"==typeof e.onclick)this.listener=function(t){e.onclick.call(this,t)};else if("undefined"!=typeof e.onclick)throw new TypeError("ChoiceTable.init: options.onclick must be function or undefined. Found: "+e.onclick);if("string"==typeof e.mainText)this.mainText=e.mainText;else if("undefined"!=typeof e.mainText)throw new TypeError("ChoiceTable.init: options.mainText must be string or undefined. Found: "+e.mainText);if(e.timeFrom===!1||"string"==typeof e.timeFrom)this.timeFrom=e.timeFrom;else if("undefined"!=typeof e.timeFrom)throw new TypeError("ChoiceTable.init: options.timeFrom must be string, false, or undefined. Found: "+e.timeFrom);if("string"==typeof e.separator)this.separator=e.separator;else if("undefined"!=typeof e.separator)throw new TypeError("ChoiceTable.init: options.separator must be string, or undefined. Found: "+e.separator);if(this.id.indexOf(e.separator)!==-1)throw new Error("ChoiceTable.init: options.separator cannot be a sequence of characters included in the table id. Found: "+e.separator);if("string"==typeof e.left||"number"==typeof e.left)this.left=""+e.left;else if(t.isNode(e.left)||t.isElement(e.left))this.left=e.left;else if("undefined"!=typeof e.left)throw new TypeError("ChoiceTable.init: options.left must be string, number, an HTML Element or undefined. Found: "+e.left);if("string"==typeof e.right||"number"==typeof e.right)this.right=""+e.right;else if(t.isNode(e.right)||t.isElement(e.right))this.right=e.right;else if("undefined"!=typeof e.right)throw new TypeError("ChoiceTable.init: options.right must be string, number, an HTML Element or undefined. Found: "+e.right);if("undefined"==typeof e.className)this.className=n.className;else{if(e.className!==!1&&"string"!=typeof e.className&&!t.isArray(e.className))throw new TypeError("ChoiceTable.init: options.className must be string, array, or undefined. Found: "+e.className);this.className=e.className}if("function"==typeof e.renderer)this.renderer=e.renderer;else if("undefined"!=typeof e.renderer)throw new TypeError("ChoiceTable.init: options.renderer must be function or undefined. Found: "+e.renderer);if("object"==typeof e.table)this.table=e.table;else if("undefined"!=typeof e.table&&!1!==e.table)throw new TypeError("ChoiceTable.init: options.table must be object, false or undefined. Found: "+e.table);this.table=e.table,this.freeText="string"==typeof e.freeText?e.freeText:!!e.freeText,"undefined"!=typeof e.choices&&this.setChoices(e.choices);if("undefined"!=typeof e.correctChoice){if(this.requiredChoice)throw new Error("ChoiceTable.init: cannot specify both options requiredChoice and correctChoice.");this.setCorrectChoice(e.correctChoice)}},n.prototype.setChoices=function(e){var n;if(!t.isArray(e))throw new TypeError("ChoiceTable.setChoices: choices must be array.");if(!e.length)throw new Error("ChoiceTable.setChoices: choices is empty array.");this.choices=e,n=e.length,this.order=t.seq(0,n-1),this.shuffleChoices&&(this.order=t.shuffle(this.order)),this.table?this.buildTableAndChoices():this.buildChoices()},n.prototype.buildChoices=function(){var e,t;e=-1,t=this.choices.length,this.choicesCells=new Array(t);for(;++e<t;)this.renderChoice(this.choices[this.order[e]],e);this.left&&this.renderSpecial("left",this.left),this.right&&this.renderSpecial("right",this.right)},n.prototype.buildTable=function(){var e,t,n,r;t=this.choicesCells.length,e=-1,r=this.orientation==="H",r&&(n=i(this,"main"),this.leftCell&&n.appendChild(this.leftCell));for(;++e<t;)r||(n=i(this,"left"),e===0&&this.leftCell&&(n.appendChild(this.leftCell),n=i(this,e))),n.appendChild(this.choicesCells[e]);this.rightCell&&(r||(n=i(this,"right")),n.appendChild(this.rightCell)),this.enable()},n.prototype.buildTableAndChoices=function(){var e,t,n,r,s;t=this.choices.length,this.choicesCells=new Array(t),e=-1,s=this.orientation==="H",s&&(n=i(this,"main"),this.left&&(r=this.renderSpecial("left",this.left),n.appendChild(r)));for(;++e<t;)s||(n=i(this,"left"),e===0&&this.left&&(r=this.renderSpecial("left",this.left),n.appendChild(r),n=i(this,e))),r=this.renderChoice(this.choices[this.order[e]],e),n.appendChild(r);this.right&&(s||(n=i(this,"right")),r=this.renderSpecial("right",this.right),n.appendChild(r)),this.enable()},n.prototype.renderSpecial=function(e,t){var n,r;n=document.createElement("td"),"string"==typeof t?n.innerHTML=t:n.appendChild(t);if(e==="left")r=this.className?this.className+"-left":"left",this.leftCell=n;else{if(e!=="right")throw new Error("ChoiceTable.renderSpecial: unknown type: "+e);r=this.className?this.className+"-right":"right",this.rightCell=n}return n.className=r,n.id=this.id+this.separator+"special-cell-"+e,n},n.prototype.renderChoice=function(e,n){var r,i;r=document.createElement("td");if(this.renderer)i=this.renderer(r,e,n),"undefined"==typeof i&&(i=n);else{t.isArray(e)?(i=e[0],e=e[1]):i=this.shuffleChoices?this.order[n]:n;if("string"==typeof e||"number"==typeof e)r.innerHTML=e;else{if(!t.isElement(e)&&!t.isNode(e))throw new Error("ChoiceTable.renderChoice: invalid choice: "+e);r.appendChild(e)}}if("undefined"!=typeof this.choicesValues[i])throw new Error("ChoiceTable.renderChoice: value already in use: "+i);if(!r.id||r.id==="")r.id=this.id+this.separator+i;return this.choicesValues[i]=n,this.choicesCells[n]=r,this.choicesIds[r.id]=r,r},n.prototype.setCorrectChoice=function(e){var n,i;if(!this.selectMultiple)e=r(this,e);else{if(!t.isArray(e)||!e.length)throw new TypeError("ChoiceTable.setCorrectChoice: choices must be non-empty array.");n=-1,i=e.length;for(;++n<i;)e[n]=r(this,e[n])}this.correctChoice=e},n.prototype.append=function(){var e;if(W.getElementById(this.id))throw new Error("ChoiceTable.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=document.createElement("span"),this.spanMainText.className=this.className?n.className+"-maintext":"maintext",this.spanMainText.innerHTML=this.mainText,this.bodyDiv.appendChild(this.spanMainText)),this.table!==!1&&("undefined"==typeof this.table&&(this.table=document.createElement("table"),this.buildTable()),this.table.id=this.id,this.className?t.addClass(this.table,this.className):this.table.className="",this.bodyDiv.appendChild(this.table)),this.freeText&&(this.textarea=document.createElement("textarea"),this.textarea.id=this.id+"_text","string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),e=this.className?this.className+"-freetext":"freetext",this.textarea.className=e,this.bodyDiv.appendChild(this.textarea))},n.prototype.listeners=function(){var t=this;e.on("INPUT_DISABLE",function(){t.disable()}),e.on("INPUT_ENABLE",function(){t.enable()})},n.prototype.disable=function(){if(this.disabled===!0)return;this.disabled=!0,this.table&&(t.removeClass(this.table,"clickable"),this.table.removeEventListener("click",this.listener))},n.prototype.enable=function(){if(this.disabled===!1)return;if(!this.table)throw new Error("ChoiceTable.enable: table not defined.");this.disabled=!1,t.addClass(this.table,"clickable"),this.table.addEventListener("click",this.listener)},n.prototype.verifyChoice=function(e){var n,r,i,s,o,u,a,f;if(this.requiredChoice!==null)return this.selectMultiple?this.currentChoice.length>=this.requiredChoice:this.currentChoice!==null;if(!this.correctChoice)return null;e="undefined"==typeof e?!0:e,e&&this.attempts.push(this.currentChoice);if(!this.selectMultiple)return this.currentChoice===this.correctChoice;f=t.isArray(this.correctChoice)?this.correctChoice:[this.correctChoice],r=f.length,s=this.currentChoice.length;if(r!==s)return!1;n=-1,u=this.currentChoice.slice(0);for(;++n<r;){a=!1,o=correctChoices[n],i=-1;for(;++i<s;)if(u[i]===o){a=!0;break}if(!a)return!1}return!0},n.prototype.setCurrentChoice=function(e){this.selectMultiple?this.currentChoice.push(e):this.currentChoice=e},n.prototype.unsetCurrentChoice=function(e){var t,n;if(!this.selectMultiple||"undefined"==typeof e)this.currentChoice=null;else{if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("ChoiceTable.unsetCurrentChoice: choice must be string, number or undefined.");t=-1,n=this.currentChoice.length;for(;++t<n;)if(this.currentChoice[t]===e){this.currentChoice.splice(t,1);break}}},n.prototype.isChoiceCurrent=function(e){var t,n;if("number"==typeof e)e=""+e;else if("string"!=typeof e)throw new TypeError("ChoiceTable.isChoiceCurrent: choice must be string or number.");if(!this.selectMultiple)return this.currentChoice===e;t=-1,n=this.currentChoice.length;for(;++t<n;)if(this.currentChoice[t]===e)return!0;return!1},n.prototype.highlight=function(e){if(!this.table)return;if(e&&"string"!=typeof e)throw new TypeError("ChoiceTable.highlight: border must be string or undefined. Found: "+e);this.table.style.border=e||"3px solid red",this.highlighted=!0},n.prototype.unhighlight=function(){if(!this.table)return;this.table.style.border="",this.highlighted=!1},n.prototype.getValues=function(e){var n,r;e=e||{},n={id:this.id,choice:e.reset?this.currentChoice:t.clone(this.currentChoice),time:this.timeCurrentChoice,nClicks:this.numberOfClicks},e.processChoice&&(n.choice=e.processChoice.call(this,n.choice)),this.shuffleChoices&&(n.order=this.order);if(this.group===0||this.group)n.group=this.group;if(this.groupOrder===0||this.groupOrder)n.groupOrder=this.groupOrder;if(null!==this.correctChoice||null!==this.requiredChoice)n.isCorrect=this.verifyChoice(e.markAttempt),n.attempts=this.attempts,!n.isCorrect&&e.highlight&&this.highlight();return this.textarea&&(n.freetext=this.textarea.value),n.isCorrect!==!1&&e.reset&&(r="object"!=typeof e.reset?{}:e.reset,this.reset(r)),n},n.prototype.setValues=function(e){var n,r,i,s,o,u,a;if(!this.choices||!this.choices.length)throw new Error("ChoiceTable.setValues: no choices found.");e=e||{};if(!this.choicesCells||!this.choicesCells.length)throw new Error("Choicetable.setValues: table was not built yet.");if(e.correct){if(!this.correctChoice||!this.correctChoice.length)throw new Error('Choicetable.setValues: "correct" is set, but no correct choice is found.');r=t.isArray(this.correctChoice)?this.correctChoice:[this.correctChoice],s=-1,o=r.length;for(;++s<o;){n=parseInt(r[s],10);if(this.shuffleChoices){u=-1,a=this.order.length;for(;++u<a;)if(this.order[u]===n){n=u;break}}this.choicesCells[n].click()}return}this.selectMultiple?o=t.randomInt(0,this.choicesCells.length):o=1,s=-1;for(;++s<o;)n=t.randomInt(0,this.choicesCells.length)-1,this.isChoiceCurrent(n)||this.choicesCells[n].click();this.textarea&&(this.textarea.value=t.randomString(100,"!Aa0"))},n.prototype.reset=function(e){var n,r;e=e||{},this.attempts=[],this.numberOfClicks=0,this.currentChoice=null,this.timeCurrentChoice=null;if(this.selected){if(!this.selectMultiple)t.removeClass(this.selected,"selected");else{n=-1,r=this.selected.length;for(;++n<r;)t.removeClass(this.selected[n],"selected")}this.selected=null}this.textArea&&(this.textArea.value=""),this.isHighlighted()&&this.unhighlight(),e.shuffleChoices&&this.shuffle()},n.prototype.shuffle=function(){var e,n,r,i,s,o,u,a,f;n=this.orientation==="H",e=t.shuffle(this.order),r=-1,i=e.length,u={},a=new Array(i);for(;++r<i;)o=e[r],s=this.choicesCells[this.choicesValues[o]],a[r]=s,u[o]=r,n?this.trs[0].appendChild(s):(f=s.parentElement||s.parentNode,this.table.appendChild(f));this.rightCell&&(n?this.trs[0].appendChild(this.rightCell):(f=this.rightCell.parentElement||this.rightCell.parentNode,this.table.appendChild(f))),this.order=e,this.choicesCells=a,this.choicesValues=u}}(node),function(e){"use strict";function n(r){var i;i=this,this.table=null,this.trs=[],this.listener=function(n){var r,s,o,u,a,f;"string"==typeof i.timeFrom?f=e.timer.getTimeSince(i.timeFrom):f=Date.now?Date.now():(new Date).getTime(),n=n||window.event,u=n.target||n.srcElement;if(!u.id||u.id==="")return;if(!i.choicesById[u.id])return;s=u.id.split(i.separator);if(s.length===1)return;r=s[0],s=s[1],o=i.itemsById[r];if(!o)return;o.timeCurrentChoice=f,o.numberOfClicks++,o.selectMultiple||(a=o.selected,a&&t.removeClass(a,"selected"),o.isChoiceCurrent(s)?o.unsetCurrentChoice(s):(o.currentChoice=s,t.addClass(u,"selected"),o.selected=u)),i.isHighlighted()&&i.unhighlight()},this.mainText=null,this.spanMainText=null,this.items=null,this.itemsById={},this.choices=null,this.choicesById={},this.itemsSettings=null,this.order=null,this.shuffleItems=null,this.requiredChoice=null,this.orientation="H",this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null,this.timeFrom="step",this.selectMultiple=null,this.renderer=null,this.separator=n.separator,this.shuffleChoices=null}function r(e,t,n){if("string"==typeof t)t={id:t};else if("object"!=typeof t)throw new TypeError("ChoiceTableGroup.buildTable: item must be string or object. Found: "+t);return t.group=e.id,t.groupOrder=n+1,t.orientation=e.orientation,t.title=!1,t.listeners=!1,t.separator=e.separator,"undefined"==typeof t.choices&&e.choices&&(t.choices=e.choices),!t.renderer&&e.renderer&&(t.renderer=e.renderer),"undefined"==typeof t.requiredChoice&&e.requiredChoice&&(t.requiredChoice=e.requiredChoice),"undefined"==typeof t.selectMultiple&&null!==e.selectMultiple&&(t.selectMultiple=e.selectMultiple),"undefined"==typeof t.shuffleChoices&&e.shuffleChoices&&(t.shuffleChoices=e.shuffleChoices),"undefined"==typeof t.timeFrom&&(t.timeFrom=e.timeFrom),"undefined"==typeof t.left&&(t.left=t.id),t}function i(t,n){var i,s;s=r(t,t.itemsSettings[t.order[n]],n),i=e.widgets.get("ChoiceTable",s);if(t.itemsById[i.id])throw new Error("ChoiceTableGroup.buildTable: an item with the same id already exists: "+i.id);if(!i.leftCell)throw new Error("ChoiceTableGroup.buildTable: item is missing a left cell: "+s.id);return t.itemsById[i.id]=i,t.items[n]=i,i}function s(e,t){var n,r;return n=document.createElement("tr"),e.table.appendChild(n),r=e.separator,n.id=e.id+r+"tr"+r+t,e.trs.push(n),n}var t=e.JSUS;e.widgets.register("ChoiceTableGroup",n),n.version="1.2.0",n.description="Groups together and manages sets of ChoiceTable widgets.",n.title="Make your choice",n.className="choicetable",n.separator="::",n.dependencies={JSUS:{}},n.prototype.init=function(e){var r,i;i=this;if(!this.id)throw new TypeError("ChoiceTableGroup.init: options.id is missing.");if("undefined"==typeof e.orientation)r="H";else{if("string"!=typeof e.orientation)throw new TypeError("ChoiceTableGroup.init: options.orientation must be string, or undefined. Found: "+e.orientation);r=e.orientation.toLowerCase().trim();if(r==="horizontal"||r==="h")r="H";else{if(r!=="vertical"&&r!=="v")throw new Error("ChoiceTableGroup.init: options.orientation is invalid: "+r);r="V"}}this.orientation=r,"undefined"==typeof e.shuffleItems?r=!1:r=!!e.shuffleItems,this.shuffleItems=r;if("number"==typeof e.requiredChoice)this.requiredChoice=e.requiredChoice;else if("boolean"==typeof e.requiredChoice)this.requiredChoice=e.requiredChoice?1:0;else if("undefined"!=typeof e.requiredChoice)throw new TypeError("ChoiceTableGroup.init: options.requiredChoice be number or boolean or undefined. Found: "+e.requiredChoice);if("string"==typeof e.group||"number"==typeof e.group)this.group=e.group;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceTableGroup.init: options.group must be string, number or undefined. Found: "+e.group);if("number"==typeof e.groupOrder)this.groupOrder=e.groupOrder;else if("undefined"!=typeof e.group)throw new TypeError("ChoiceTableGroup.init: options.groupOrder must be number or undefined. Found: "+e.groupOrder);if("function"==typeof e.onclick)this.listener=function(t){e.onclick.call(this,t)};else if("undefined"!=typeof e.onclick)throw new TypeError("ChoiceTableGroup.init: options.onclick must be function or undefined. Found: "+e.onclick);if("string"==typeof e.mainText)this.mainText=e.mainText;else if("undefined"!=typeof e.mainText)throw new TypeError("ChoiceTableGroup.init: options.mainText must be string or undefined. Found: "+e.mainText);if(e.timeFrom===!1||"string"==typeof e.timeFrom)this.timeFrom=e.timeFrom;else if("undefined"!=typeof e.timeFrom)throw new TypeError("ChoiceTableGroup.init: options.timeFrom must be string, false, or undefined. Found: "+e.timeFrom);"undefined"!=typeof e.shuffleChoices&&(this.shuffleChoices=!!e.shuffleChoices);if("function"==typeof e.renderer)this.renderer=e.renderer;else if("undefined"!=typeof e.renderer)throw new TypeError("ChoiceTableGroup.init: options.renderer must be function or undefined. Found: "+e.renderer);"undefined"!=typeof e.choices&&(this.choices=e.choices);if("undefined"==typeof e.className)this.className=n.className;else{if(e.className!==!1&&"string"!=typeof e.className&&!t.isArray(e.className))throw new TypeError("ChoiceTableGroup.init: options.className must be string, array, or undefined. Found: "+e.className);this.className=e.className}if("object"==typeof e.table)this.table=e.table;else if("undefined"!=typeof e.table&&!1!==e.table)throw new TypeError("ChoiceTableGroup.init: options.table must be object, false or undefined. Found: "+e.table);this.table=e.table,this.freeText="string"==typeof e.freeText?e.freeText:!!e.freeText,"undefined"!=typeof e.items&&this.setItems(e.items)},n.prototype.setItems=function(e){var n;if(!t.isArray(e))throw new TypeError("ChoiceTableGroup.setItems: items must be array.");if(!e.length)throw new Error("ChoiceTableGroup.setItems: items is empty array.");n=e.length,this.itemsSettings=e,this.items=new Array(n),this.order=t.seq(0,n-1),this.shuffleItems&&(this.order=t.shuffle(this.order)),this.table&&this.buildTable()},n.prototype.buildTable=function(){var e,t,n,r,o,u,a,f,l,c;r=this.orientation==="H",e=-1,t=this.itemsSettings.length;if(r)for(;++e<t;){o=i(this,e),n=s(this,o.id),n.appendChild(o.leftCell),u=-1,a=o.choicesCells.length;if(e===0)f=a;else if(a!==f)throw new Error("ChoiceTableGroup.buildTable: item do not have same number of choices: "+o.id);for(;++u<a;)c=o.choicesCells[u],n.appendChild(c),this.choicesById[c.id]=c;o.rightCell&&n.appendChild(o.rightCell)}else{n=s(this,"header");for(;++e<t;){o=i(this,e),a=o.choicesCells.length;if(e===0)f=a;else if(a!==f)throw new Error("ChoiceTableGroup.buildTable: item do not have same number of choices: "+o.id);if("undefined"==typeof l)l=!!o.rightCell;else if(!o.rightCell&&l||o.rightCell&&!l)throw new Error("ChoiceTableGroup.buildTable: either all items or no item must have the right cell: "+o.id);n.appendChild(o.leftCell)}l&&a++,u=-1;for(;++u<a;){n=s(this,"row"+(u+1)),e=-1;for(;++e<t;)l&&u===a-1?n.appendChild(this.items[e].rightCell):(c=this.items[e].choicesCells[u],n.appendChild(c),this.choicesById[c.id]=c)}}this.enable()},n.prototype.append=function(){if(W.getElementById(this.id))throw new Error("ChoiceTableGroup.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=document.createElement("span"),this.spanMainText.className=n.className+"-maintext",this.spanMainText.innerHTML=this.mainText,this.bodyDiv.appendChild(this.spanMainText)),this.table!==!1&&("undefined"==typeof this.table&&(this.table=document.createElement("table"),this.items&&this.buildTable()),this.table.id=this.id,this.className?t.addClass(this.table,this.className):this.table.className="",this.bodyDiv.appendChild(this.table)),this.freeText&&(this.textarea=document.createElement("textarea"),this.textarea.id=this.id+"_text",this.textarea.className=n.className+"-freetext","string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),this.bodyDiv.appendChild(this.textarea))},n.prototype.listeners=function(){var t=this;e.on("INPUT_DISABLE",function(){t.disable()}),e.on("INPUT_ENABLE",function(){t.enable()})},n.prototype.disable=function(e){if(this.disabled===!0)return;this.disabled=!0,this.table&&(t.removeClass(this.table,"clickable"),this.table.removeEventListener("click",this.listener))},n.prototype.enable=function(e){if(this.disabled===!1)return;if(!this.table)throw new Error("ChoiceTableGroup.enable: table not defined.");this.disabled=!1,t.addClass(this.table,"clickable"),this.table.addEventListener("click",this.listener)},n.prototype.verifyChoice=function(e){var t,n,r;r={},e="undefined"==typeof e?!0:e,t=-1,n=this.items.length;for(;++t<n;)r[this.items[t].id]=this.items[t].verifyChoice(e);return r},n.prototype.setCurrentChoice=function(e){var t,n;t=-1,n=this.items[t].length;for(;++t<n;)this.items[t].setCurrentChoice(e)},n.prototype.unsetCurrentChoice=function(e){var t,n;t=-1,n=this.items.length;for(;++t<n;)this.items[t].unsetCurrentChoice(e)},n.prototype.highlight=function(e){if(!this.table)return;if(e&&"string"!=typeof e)throw new TypeError("ChoiceTableGroup.highlight: border must be string or undefined. Found: "+e);this.table.style.border=e||"3px solid red",this.highlighted=!0},n.prototype.unhighlight=function(){if(!this.table)return;this.table.style.border="",this.highlighted=!1},n.prototype.getValues=function(e){var t,n,r,i,s,o;t={id:this.id,order:this.order,items:{}},e=e||{},o=e.reset,e.reset=!1,n=-1,r=this.items.length;for(;++n<r;)i=this.items[n],t.items[i.id]=i.getValues(e),t.items[i.id].choice===null&&(t.missValues=!0,i.requiredChoice&&(s=!0)),t.items[i.id].isCorrect===!1&&e.highlight&&(s=!0);return s?this.highlight():o&&this.reset(o),this.textarea&&(t.freetext=this.textarea.value),t},n.prototype.setValues=function(e){var n,r;if(!this.items||!this.items.length)throw new Error("ChoiceTableGroup.setValues: no items found.");e=e||{},n=-1,r=this.items.length;for(;++n<r;)this.items[n].setValues(e);this.textarea&&(this.textarea.value=t.randomString(100,"!Aa0"))},n.prototype.reset=function(e){var t,n;e=e||{},t=-1,n=this.items.length;for(;++t<n;)this.items[t].reset(e);this.textarea&&(this.textarea.value=""),e.shuffleItems&&this.shuffle(),this.isHighlighted()&&this.unhighlight()},n.prototype.shuffle=function(e){var n,r,i,s,o;if(!this.items||!this.items.length)return;n=t.shuffle(this.order);if(this.orientation==="H")t.shuffleElements(this.table,n);else{r=-1,i=this.trs.length;for(;++r<i;)t.shuffleElements(this.trs[r],n)}this.order=n}}(node),function(e){"use strict";function t(e){this.options=e,this.listRoot=null,this.submit=null,this.changeEvent="Controls_change",this.hasChanged=!1,this.init(e)}function n(e){t.call(this,e)}function r(e){t.call(this,e)}function i(n){t.call(this,n),this.groupName="undefined"!=typeof n.name?n.name:e.window.generateUniqueId(),this.radioElem=null}e.widgets.register("Controls",t),t.version="0.5.0",t.description="Wraps a collection of user-inputs controls.",t.title="Controls",t.className="controls",t.prototype.add=function(e,t,n){},t.prototype.getItem=function(e,t){},t.prototype.init=function(e){this.hasChanged=!1,"undefined"!=typeof e.change&&(e.change?this.changeEvent=e.change:this.changeEvent=!1),this.list=new W.List(e),this.listRoot=this.list.getRoot();if(!e.features)return;this.features=e.features,this.populate()},t.prototype.append=function(){var t=this,n="submit_Controls";this.list.parse(),this.bodyDiv.appendChild(this.listRoot),this.options.submit&&(this.options.submit.id&&(n=this.options.submit.id,this.option.submit=this.option.submit.name),this.submit=e.window.addButton(this.bodyDiv,n,this.options.submit,this.options.attributes),this.submit.onclick=function(){t.options.change&&e.emit(t.options.change)})},t.prototype.parse=function(){return this.list.parse()},t.prototype.populate=function(){var t,n,r,i,s,o=this;for(t in this.features)this.features.hasOwnProperty(t)&&(r=this.features[t],n=t,r.id&&(n=r.id,delete r.id),i=document.createElement("div"),s=this.add(i,n,r),this.changeEvent&&(s.onchange=function(){e.emit(o.changeEvent)}),r.label&&W.addLabel(i,s,null,r.label),this.list.addDT(i))},t.prototype.listeners=function(){var t=this;e.on(this.changeEvent,function(){t.hasChanged=!0})},t.prototype.refresh=function(){var t,n;for(t in this.features)this.features.hasOwnProperty(t)&&(n=e.window.getElementById(t),n&&(n.value=this.features[t].value));return!0},t.prototype.getValues=function(){var t,n,r;t={};for(r in this.features)this.features.hasOwnProperty(r)&&(n=e.window.getElementById(r),n&&(t[r]=Number(n.value)));return t},t.prototype.highlight=function(t){return e.window.highlight(this.listRoot,t)},n.prototype.__proto__=t.prototype,n.prototype.constructor=n,n.version="0.2.1",n.description="Collection of Sliders.",n.title="Slider Controls",n.className="slidercontrols",n.dependencies={Controls:{}},e.widgets.register("SliderControls",n),n.prototype.add=function(t,n,r){return e.window.addSlider(t,n,r)},n.prototype.getItem=function(t,n){return e.window.getSlider(t,n)},r.prototype.__proto__=t.prototype,r.prototype.constructor=r,r.version="0.14",r.description="Collection of jQuery Sliders.",r.title="jQuery Slider Controls",r.className="jqueryslidercontrols",r.dependencies={jQuery:{},Controls:{}},e.widgets.register("jQuerySliderControls",r),r.prototype.add=function(e,t,n){var r=jQuery("<div/>",{id:t}).slider(),i=r.appendTo(e);return i[0]},r.prototype.getItem=function(e,t){var n=jQuery("<div/>",{id:e}).slider();return n},i.prototype.__proto__=t.prototype,i.prototype.constructor=i,i.version="0.1.2",i.description="Collection of Radio Controls.",i.title="Radio Controls",i.className="radiocontrols",i.dependencies={Controls:{}},e.widgets.register("RadioControls",i),i.prototype.populate=function(){var t,n,r,i,s;s=this,this.radioElem||(this.radioElem=document.createElement("radio"),this.radioElem.group=this.name||"radioGroup",this.radioElem.group=this.className||"radioGroup",this.bodyDiv.appendChild(this.radioElem));for(t in this.features)this.features.hasOwnProperty(t)&&(r=this.features[t],n=t,r.id&&(n=r.id,delete r.id),i=this.add(this.radioElem,n,r),this.changeEvent&&(i.onchange=function(){e.emit(s.changeEvent)}),this.list.addDT(i))},i.prototype.add=function(t,n,r){var i;return"undefined"==typeof r.name&&(r.name=this.groupName),i=e.window.addRadioButton(t,n,r),i.appendChild(document.createTextNode(r.label)),i},i.prototype.getItem=function(t,n){return"undefined"==typeof n.name&&(n.name=this.groupName),e.window.getRadioButton(t,n)},i.prototype.getValues=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);if(n.checked)return n.value}return!1}}(node),function(e){"use strict";function t(n){this.id=n.id||t.id,this.event=n.event||"D3",this.svg=null;var r=this;e.on(this.event,function(e){r.tick.call(r,e)})}function n(e){var r,i,s;t.call(this,e),this.options=r=JSUS.merge(n.defaults,e),this.n=r.n,this.data=[0],this.margin=r.margin,this.width=r.width-this.margin.left-this.margin.right,this.height=r.height-this.margin.top-this.margin.bottom,this.x=i=d3.scale.linear().domain(r.domain.x).range(r.range.x),this.y=s=d3.scale.linear().domain(r.domain.y).range(r.range.y),this.line=d3.svg.line().x(function(e,t){return i(t)}).y(function(e,t){return s(e)})}e.widgets.register("D3",t),e.widgets.register("D3ts",n),t.prototype.__proto__=e.Widget.prototype,t.prototype.constructor=t,t.defaults={},t.defaults.id="D3",t.defaults.fieldset={legend:"D3 plot"},t.version="0.1",t.description="Real time plots for nodeGame with d3.js",t.dependencies={d3:{},JSUS:{}},t.prototype.append=function(e){return this.root=e,this.svg=d3.select(e).append("svg"),e},t.prototype.tick=function(){},n.id="D3ts",n.version="0.1",n.description="Time series plot for nodeGame with d3.js",n.dependencies={D3:{},JSUS:{}},n.prototype.__proto__=t.prototype,n.prototype.constructor=n,n.defaults={},n.defaults.width=400,n.defaults.height=200,n.defaults.margin={top:10,right:10,bottom:20,left:40},n.defaults.domain={x:[0,10],y:[0,1]},n.defaults.range={x:[0,n.defaults.width],y:[n.defaults.height,0]},n.prototype.init=function(e){console.log("init!");var t=this.x,n=this.y,r=this.height,i=this.width,s=this.margin;this.svg.attr("width",i+s.left+s.right).attr("height",r+s.top+s.bottom).append("g").attr("transform","translate("+s.left+","+s.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",i).attr("height",r),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.svg.axis().scale(t).orient("bottom")),this.svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(n).orient("left")),this.path=this.svg.append("g").attr("clip-path","url(#clip)").append("path").data([this.data]).attr("class","line").attr("d",this.line)},n.prototype.tick=function(e){this.alreadyInit=this.alreadyInit||!1,this.alreadyInit||(this.init(),this.alreadyInit=!0);var t=this.x;console.log("tick!"),this.data.push(e),this.path.attr("d",this.line).attr("transform",null),this.data.length>this.n&&(this.path.transition().duration(500).ease("linear").attr("transform","translate("+t(-1)+")"),this.data.shift())}}(node),function(e){"use strict";function r(){this.table=null,this.interval=null,this.intervalTime=1e3}var t=e.JSUS,n=e.window.Table;e.widgets.register("DebugInfo",r),r.version="0.6.0",r.description="Display basic info a client's status.",r.title="Debug Info",r.className="debuginfo",r.dependencies={Table:{}},r.prototype.init=function(e){"number"==typeof e.intervalTime&&(this.intervalTime=e.intervalTime)},r.prototype.append=function(){var e;this.table=new n,this.bodyDiv.appendChild(this.table.table),this.updateAll(),e=this,this.interval=setInterval(function(){e.updateAll()},this.intervalTime)},r.prototype.updateAll=function(){var n,r,i,s,o,u,a,f,l,c,h,p;if(!this.bodyDiv){e.err("DebugInfo.updateAll: bodyDiv not found.");return}p="-",i=p,r=p,n=e.game.getCurrentGameStage(),n&&(h=e.game.plot.getStep(n),i=h?h.id:"-",r=n.toString()),o=t.getKeyByValue(e.constants.stageLevels,e.game.getStageLevel()),u=t.getKeyByValue(e.constants.stateLevels,e.game.getStateLevel()),a=t.getKeyByValue(e.constants.windowLevels,W.getStateLevel()),s=e.player?e.player.id:p,f=e.errorManager.lastErr||p,c=e.game.settings&&e.game.settings.treatmentName?e.game.settings.treatmentName:p,l=e.socket.connected?"yes":"no",this.table.clear(!0),this.table.addRow(["Treatment: ",c]),this.table.addRow(["Connected: ",l]),this.table.addRow(["Player Id: ",s]),this.table.addRow(["Stage  No: ",r]),this.table.addRow(["Stage  Id: ",i]),this.table.addRow(["Stage Lvl: ",o]),this.table.addRow(["State Lvl: ",u]),this.table.addRow(["Players  : ",e.game.pl.size()]),this.table.addRow(["Win   Lvl: ",a]),this.table.addRow(["Win Loads: ",W.areLoading]),this.table.addRow(["Last  Err: ",f]),this.table.parse()},r.prototype.destroy=function(){clearInterval(this.interval),this.interval=null,e.silly("DebugInfo destroyed.")}}(node),function(e){"use strict";function t(){this.disconnectButton=null,this.ee=null}e.widgets.register("DisconnectBox",t),t.version="0.2.2",t.description="Visually display current, previous and next stage of the game.",t.title="Disconnect",t.className="disconnectbox",t.dependencies={},t.prototype.append=function(){this.disconnectButton=W.getButton(undefined,"Leave Experiment"),this.disconnectButton.className="btn btn-lg",this.bodyDiv.appendChild(this.disconnectButton),this.disconnectButton.onclick=function(){e.socket.disconnect()}},t.prototype.listeners=function(){var t=this;this.ee=e.getCurrentEventEmitter(),this.ee.on("SOCKET_DISCONNECT",function(){console.log("DB got socket_diconnect"),t.disconnectButton.disabled=!0}),this.ee.on("SOCKET_CONNECT",function(){console.log("DB got socket_connect")})},t.prototype.destroy=function(){this.ee.off("SOCKET_DISCONNECT","DBdiscon"),this.ee.off("SOCKET_CONNECT","DBcon")}}(node),function(e){"use strict";function n(t){var n;n=this;if("object"==typeof t.button)this.button=t.button;else{if("undefined"!=typeof t.button)throw new TypeError("DoneButton constructor: options.button must be object or undefined. Found: "+t.button);this.button=document.createElement("input"),this.button.type="button"}this.button.onclick=function(){var t;t=e.done(),t&&n.disable()},this.init(t)}var t=e.JSUS;e.widgets.register("DoneButton",n),n.version="0.2.0",n.description="Creates a button that if pressed emits node.done().",n.title="Done Button",n.className="donebutton",n.text="I am done",n.dependencies={JSUS:{}},n.prototype.init=function(e){var r;e=e||{};if("undefined"==typeof e.id)r=n.className;else if("string"==typeof e.id)r=e.id;else{if(!1!==e.id)throw new TypeError("DoneButton.init: options.id must be string, false, or undefined. Found: "+e.id);r=""}this.button.id=r;if("undefined"==typeof e.className)r="btn btn-lg btn-primary";else if(e.className===!1)r="";else if("string"==typeof e.className)r=e.className;else{if(!t.isArray(e.className))throw new TypeError("DoneButton.init: options.className must be string, array, or undefined. Found: "+e.className);r=e.className.join(" ")}this.button.className=r,this.setText(e.text)},n.prototype.append=function(){this.bodyDiv.appendChild(this.button)},n.prototype.listeners=function(){var t=this;e.on("PLAYING",function(){var n,r;r=e.game.getCurrentGameStage(),n=e.game.plot.getProperty(r,"donebutton"),n===!1||n&&n.enableOnPlaying===!1?t.disable():t.enable(),n&&n.text&&(t.button.value=n.text)})},n.prototype.disable=function(){this.button.disabled="disabled"},n.prototype.enable=function(){this.button.disabled=!1},n.prototype.setText=function(e){if("undefined"==typeof e)e=n.text;else if("string"!=typeof e)throw new TypeError("DoneButton.setText: text must be string or undefined. Found: "+typeof e);this.button.value=e}}(node),function(e){"use strict";function s(e,t){n.call(this,e,t),this.options=e,this.name=e.name||"Dynamic Table",this.root=null,this.bindings={},this.init(this.options)}var t=e.GameStage,n=e.window.Table,r=e.window.HTMLRenderer,i=e.JSUS;e.widgets.register("DynamicTable",s),s.prototype=new n,s.prototype.constructor=n,s.id="dynamictable",s.version="0.3.1",s.dependencies={Table:{},JSUS:{},HTMLRenderer:{}},s.prototype.init=function(e){this.options=e,this.name=e.name||this.name,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!0,this.replace=e.replace||!1,this.htmlRenderer=new r({renderers:e.renderers}),this.c("state",t.compare),this.setLeft([]),this.parse(!0)},s.prototype.bind=function(t,r){if(!t||!r)return;var s=this;e.on(t,function(e){if(r.x||r.y){var t;s.replace?t=function(t,i){var o=s.get(t,i);if(o.length!==0)for(var u=0;u<o.length;u++)r.cell.call(s,e,o[u]);else{var a=r.cell.call(s,e,new n.Cell({x:t,y:i}));s.add(a)}}:t=function(t,i){var o=r.cell.call(s,e,new n.Cell({x:t,y:i}));s.add(o,t,i)};var o=r.x.call(s,e),u=r.y.call(s,e);if(o&&u){o=o instanceof Array?o:[o],u=u instanceof Array?u:[u];for(var a=0;a<o.length;a++)for(var f=0;f<u.length;f++)t.call(s,o[a],u[f])}}if(r.header){var l=r.header.call(s,e);l=l instanceof Array?l:[l],s.setHeader(l)}if(r.left){var c=r.left.call(s,e);i.inArray(c,s.left)||s.header.push(c)}s.auto_update&&s.parse()})},s.prototype.append=function(e){return this.root=e,e.appendChild(this.table),e},s.prototype.listeners=function(){}}(node),function(){function e(e){if("undefined"==typeof e.headerMessage)this.headerMessage="Thank you for participating!";else{if("string"!=typeof e.headerMessage)throw new TypeError("EndScreen constructor: options.headerMessage must be string or undefined. Found: "+e.headerMessage);this.headerMessage=e.headerMessage}if("undefined"==typeof e.message)this.message="You have now completed this task and your data has been saved. Please go back to the Amazon Mechanical Turk web site and submit the HIT.";else{if("string"!=typeof e.message)throw new TypeError("EndScreen constructor: options.message must be string or undefined. Found: "+e.message);this.message=e.message}if("undefined"==typeof e.showEmailForm)this.showEmailForm=!0;else{if("boolean"!=typeof e.showEmailForm)throw new TypeError("EndScreen constructor: options.showEmailForm must be boolean or undefined. Found: "+e.showEmailForm);this.showEmailForm=e.showEmailForm}if("undefined"==typeof e.showFeedbackForm)this.showFeedbackForm=!0;else{if("boolean"!=typeof e.showFeedbackForm)throw new TypeError("EndScreen constructor: options.showFeedbackForm must be boolean or undefined. Found: "+e.showFeedbackForm);this.showFeedbackForm=e.showFeedbackForm}if("undefined"==typeof e.showTotalWin)this.showTotalWin=!0;else{if("boolean"!=typeof e.showTotalWin)throw new TypeError("EndScreen constructor: options.showTotalWin must be boolean or undefined. Found: "+e.showTotalWin);this.showTotalWin=e.showTotalWin}if("undefined"==typeof e.showExitCode)this.showExitCode=!0;else{if("boolean"!=typeof e.showExitCode)throw new TypeError("EndScreen constructor: options.showExitCode must be boolean or undefined. Found: "+e.showExitCode);this.showExitCode=e.showExitCode}this.feedback=node.widgets.get("Feedback",e),this.endScreenHTML=null,this.init()}node.widgets.register("EndScreen",e),e.version="0.1.0",e.description="Game end screen. With end game message, email form, and exit code.",e.title="End Screen",e.className="end-screen",e.dependencies={JSUS:{}},e.prototype.append=function(){this.endScreenHTML=this.makeEndScreen(),this.bodyDiv.append(this.endScreenHTML)},e.prototype.makeEndScreen=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;return d="Not a valid email address, please correct it and submit again.",e=document.createElement("div"),e.className="endscreen",t=document.createElement("h1"),t.innerHTML=this.headerMessage,e.appendChild(t),n=document.createElement("p"),n.innerHTML=this.message,e.appendChild(n),this.showTotalWin&&(r=document.createElement("div"),i=document.createElement("p"),i.innerHTML="Your total win: ",s=document.createElement("input"),s.className="endscreen-total form-control",s.setAttribute("disabled","true"),i.appendChild(s),r.appendChild(i),e.appendChild(r),this.totalWinInputElement=s),this.showExitCode&&(o=document.createElement("div"),u=document.createElement("p"),u.innerHTML="Your exit code: ",a=document.createElement("input"),a.className="endscreen-exit-code form-control",a.setAttribute("disabled","true"),u.appendChild(a),o.appendChild(u),e.appendChild(o),this.exitCodeInputElement=a),this.showEmailForm&&(f=document.createElement("div"),l=document.createElement("form"),l.className="endscreen-email-form",c=document.createElement("label"),c.innerHTML="Would you like to be contacted again for future experiments? If so, leave your email here and press submit: ",h=document.createElement("input"),h.setAttribute("type","text"),h.setAttribute("placeholder","Email"),h.className="endscreen-email-input form-control",p=document.createElement("input"),p.setAttribute("type","submit"),p.setAttribute("value","Submit email"),p.className="btn btn-lg btn-primary endscreen-email-submit",l.appendChild(c),l.appendChild(h),l.appendChild(p),f.appendChild(l),e.appendChild(f),l.addEventListener("submit",function(e){var t,n,r;e.preventDefault(),t=h.value,t.trim().length>5&&(n=t.indexOf("@"),n!==-1&&n!==0&&n!==t.length-1&&(r=t.lastIndexOf("."),r!==-1&&r!==t.length-1&&r>n+1&&(node.say("email","SERVER",t),p.disabled=!0,h.disabled=!0,p.value="Sent!"))),p.value=d},!0)),this.showFeedbackForm&&node.widgets.append(this.feedback,e),e},e.prototype.listeners=function(){var e;e=this,node.on.data("WIN",function(t){var n,r,i,s,o;i=t.data,n=i.total,r=i.exit,JSUS.isNumber(n,0)===!1&&(node.err("EndScreen error, invalid exit code: "+n),n="Error: invalid total win."),typeof r!="string"&&(node.err("EndScreen error, invalid exit code: "+r),r="Error: invalid exit code."),s=e.totalWinInputElement,o=e.exitCodeInputElement,s&&e.showTotalWin&&(s.value=n),o&&e.showExitCode&&(o.value=r)})}}(node),function(e){"use strict";function n(e){if("undefined"==typeof e.label)this.label="Any feedback about the experiment? Let us know here:";else{if("string"!=typeof e.label)throw new TypeError("Feedback constructor: options.label must be string or undefined. Found: "+e.label);this.label=e.label}if("undefined"==typeof e.maxLength)this.maxFeedbackLength=800;else{if(JSUS.isNumber(e.maxLength,0)===!1)throw new TypeError("Feedback constructor: options.maxLength must be a number >= 0 or undefined. Found: "+e.maxLength);this.maxFeedbackLength=e.maxLength}if("undefined"==typeof e.minLength)this.minFeedbackLength=0;else{if(JSUS.isNumber(e.minLength,0)===!1)throw new TypeError("Feedback constructor: options.minLength must be a number >= 0 or undefined. Found: "+e.minLength);this.minFeedbackLength=e.minLength}this.feedbackHTML=null}function r(e,t,n,r,i){var s;s=e.value.trim().length,s<r?(n.disabled=!0,t.innerHTML=r-s+" characters needed.",t.style.backgroundColor="#f2dede"):s>i?(n.disabled=!0,t.innerHTML=s-i+" characters over.",t.style.backgroundColor="#f2dede"):(n.disabled=!1,t.innerHTML=i-s+" characters remaining.",t.style.backgroundColor="#dff0d8")}var t=e.JSUS;e.widgets.register("Feedback",n),n.version="0.3",n.description="Displays a simple feedback form.",n.title="Feedback",n.className="feedback",n.dependencies={JSUS:{}},n.prototype.createForm=function(t,n,i,s){var o,u,a,f,l,c;return o=document.createElement("div"),o.className="feedback",u=document.createElement("form"),u.className="feedback-form",o.appendChild(u),a=document.createElement("label"),a.setAttribute("for","feedback-input"),a.innerHTML=s,u.appendChild(a),f=document.createElement("textarea"),f.className="feedback-textarea form-control",f.setAttribute("type","text"),f.setAttribute("rows","3"),u.appendChild(f),l=document.createElement("input"),l.className="btn btn-lg btn-primary",l.setAttribute("type","submit"),l.setAttribute("value","Submit feedback"),u.appendChild(l),c=document.createElement("span"),c.className="feedback-char-count badge",c.innerHTML=i,u.appendChild(c),u.addEventListener("submit",function(t){var n;t.preventDefault(),n=f.value.trim(),e.say("feedback","SERVER",n),l.disabled=!0,f.disabled=!0,l.setAttribute("value","Sent!")}),u.addEventListener("input",function(e){r(f,c,l,n,i)}),r(f,c,l,n,i),o},n.prototype.append=function(){this.feedbackHTML=this.createForm(this.showCharCount,this.minFeedbackLength,this.maxFeedbackLength,this.label),this.bodyDiv.appendChild(this.feedbackHTML)},n.prototype.listeners=function(){}}(node),function(e){"use strict";function t(e){this.board=null,this.status=null}function n(t){var n,r,i;r=e.constants.stageLevels,n="["+(t.name||t.id)+"]> 	",n+="("+t.stage.round+") "+t.stage.stage+"."+t.stage.step,n+=" ";switch(t.stageLevel){case r.UNINITIALIZED:i="uninit.";break;case r.INITIALIZING:i="init...";break;case r.INITIALIZING:i="init!";break;case r.LOADING:i="loading";break;case r.LOADED:i="loaded";break;case r.PLAYING:i="playing";break;case r.DONE:i="done";break;default:i=t.stageLevel}return n+"("+i+")"}function r(){return W.getElement("hr",null,{style:"color: #CCC;"})}e.widgets.register("GameBoard",t),t.version="0.4.1",t.description="Offer a visual representation of the state of all players in the game.",t.title="Game Board",t.className="gameboard",t.prototype.append=function(){this.status=e.window.addDiv(this.bodyDiv,"gboard_status"),this.board=e.window.addDiv(this.bodyDiv,"gboard"),this.updateBoard(e.game.pl)},t.prototype.listeners=function(){var t=this;e.on("UPDATED_PLIST",function(){t.updateBoard(e.game.pl)})},t.prototype.updateBoard=function(t){var i,s,o=this;this.status.innerHTML="Updating...",t.size()&&(o.board.innerHTML="",t.forEach(function(e){i=n(e),W.write(i,o.board),s=r(),W.write(s,o.board)})),this.status.innerHTML="Connected players: "+e.game.pl.length}}(node),function(e){"use strict";function r(e){this.options=e,this.id=e.id,this.name=e.name||r.name,this.root=null,this.gtbl=null,this.plist=null,this.init(this.options)}var t=e.GameStage,n=e.PlayerList;e.widgets.register("GameTable",r),r.defaults={},r.defaults.id="gametable",r.defaults.fieldset={legend:"Game Table",id:"gametable_fieldset"},r.version="0.3",r.dependencies={JSUS:{}},r.prototype.init=function(r){this.plist||(this.plist=new n),this.gtbl=new e.window.Table({auto_update:!0,id:r.id||this.id,render:r.render},e.game.memory.db),this.gtbl.c("state",t.compare),this.gtbl.setLeft([]),this.gtbl.parse(!0)},r.prototype.addRenderer=function(e){return this.gtbl.addRenderer(e)},r.prototype.resetRender=function(){return this.gtbl.resetRenderer()},r.prototype.removeRenderer=function(e){return this.gtbl.removeRenderer(e)},r.prototype.append=function(e){return this.root=e,e.appendChild(this.gtbl.table),e},r.prototype.listeners=function(){var t=this;e.on.plist(function(e){if(!e.data.length)return;var r=new n({},e.data),i=r.diff(t.plist);i&&i.forEach(function(e){t.addPlayer(e)}),t.gtbl.parse(!0)}),e.on("in.set.DATA",function(n){t.addLeft(n.state,n.from);var r=t.player2x(n.from),i=t.state2y(e.game.state,n.text);t.gtbl.add(n.data,r,i),t.gtbl.parse(!0)})},r.prototype.addPlayer=function(e){this.plist.add(e);var t=this.plist.map(function(e){return e.name});this.gtbl.setHeader(t)},r.prototype.addLeft=function(e,n){if(!e)return;e=new t(e);if(!JSUS.in_array({content:e.toString(),type:"left"},this.gtbl.left))this.gtbl.add2Left(e.toString());else{var r=this.state2y(e),i=this.player2x(n);this.gtbl.select("y","=",r).select("x","=",i).count()>1&&this.gtbl.add2Left(e.toString())}},r.prototype.player2x=function(e){return e?this.plist.select("id","=",e).first().count:!1},r.prototype.x2Player=function(e){return e?this.plist.select("count","=",e).first().count:!1},r.prototype.state2y=function(t){return t?e.game.plot.indexOf(t):!1},r.prototype.y2State=function(n){return n?e.game.plot.jumpTo(new t,n):!1}}(node),function(e){"use strict";function n(t){var n=this;this.options=t,this.availableLanguages={en:{name:"English",nativeName:"English",shortName:"en"}},this.currentLanguage=null,this.buttonListLength=null,this.displayForm=null,this.optionsLabel={},this.optionsDisplay={},this.loadingDiv=null,this.languagesLoaded=!1,this.usingButtons=null,this.onLangCallback=function(t){function i(e){return function(){n.setLanguage(e)}}var r;while(n.displayForm.firstChild)n.displayForm.removeChild(n.displayForm.firstChild);n.availableLanguages=t.data;if(n.usingButtons)for(r in t.data)t.data.hasOwnProperty(r)&&(n.optionsLabel[r]=W.getElement("label",r+"Label",{"for":r+"RadioButton"}),n.optionsDisplay[r]=W.getElement("input",r+"RadioButton",{type:"radio",name:"languageButton",value:t.data[r].name}),n.optionsDisplay[r].onclick=i(r),n.optionsLabel[r].appendChild(n.optionsDisplay[r]),n.optionsLabel[r].appendChild(document.createTextNode(t.data[r].nativeName)),e.window.addElement("br",n.displayForm),n.optionsLabel[r].className="unselectedButtonLabel",n.displayForm.appendChild(n.optionsLabel[r]));else{n.displaySelection=e.window.getElement("select","selectLanguage");for(r in t.data)n.optionsLabel[r]=document.createTextNode(t.data[r].nativeName),n.optionsDisplay[r]=e.window.getElement("option",r+"Option",{value:r}),n.optionsDisplay[r].appendChild(n.optionsLabel[r]),n.displaySelection.appendChild(n.optionsDisplay[r]);n.displayForm.appendChild(n.displaySelection),n.displayForm.onchange=function(){n.setLanguage(n.displaySelection.value)}}n.loadingDiv.style.display="none",n.languagesLoaded=!0,n.setLanguage("en"),n.onLangCallbackExtension&&(n.onLangCallbackExtension(t),n.onLangCallbackExtension=null)},this.onLangCallbackExtension=null,this.init(this.options)}var t=e.JSUS;e.widgets.register("LanguageSelector",n),n.version="0.3.1",n.description="Display information about the current language and allows to change language.",n.title="Language",n.className="languageselector",n.dependencies={JSUS:{}},n.prototype.init=function(n){t.mixout(n,this.options),this.options=n,this.usingButtons=this.options.usingButtons||!0,e.on.lang(this.onLangCallback),this.displayForm=e.window.getElement("form","radioButtonForm"),this.loadingDiv=e.window.addDiv(this.displayForm),this.loadingDiv.innerHTML="Loading language information...",this.loadLanguages()},n.prototype.append=function(){this.bodyDiv.appendChild(this.displayForm)},n.prototype.setLanguage=function(t){this.usingButtons&&this.currentLanguage!==null&&this.currentLanguage!==this.availableLanguages[t]&&(this.optionsDisplay[this.currentLanguage].checked="unchecked",this.optionsLabel[this.currentLanguage].className="unselectedButtonLabel"),this.currentLanguage=t,this.usingButtons?(this.optionsDisplay[this.currentLanguage].checked="checked",this.optionsLabel[this.currentLanguage].className="selectedButtonLabel"):this.displaySelection.value=this.currentLanguage,e.setLanguage(this.availableLanguages[this.currentLanguage])},n.prototype.updateAvalaibleLanguages=function(t){t&&t.callback&&(this.onLangCallbackExtension=t.callback),e.socket.send(e.msg.create({target:"LANG",to:"SERVER",action:"get"}))},n.prototype.loadLanguages=function(e){this.languagesLoaded?e&&e.callback&&e.callback():this.updateAvalaibleLanguages(e)}}(node),function(e){"use strict";function t(e){this.spanCurrency=document.createElement("span"),this.spanMoney=document.createElement("span"),this.currency="ECU",this.money=0,this.precision=2,this.init(e)}e.widgets.register("MoneyTalks",t),t.version="0.3.0",t.description="Displays the earnings of a player.",t.title="Earnings",t.className="moneytalks",t.dependencies={JSUS:{}},t.prototype.init=function(e){this.currency="string"==typeof e.currency?e.currency:this.currency,this.money="number"==typeof e.money?e.money:this.money,this.precision="number"==typeof e.precision?e.precision:this.precision,this.spanCurrency.className=e.currencyClassName||this.spanCurrency.className||"moneytalkscurrency",this.spanMoney.className=e.moneyClassName||this.spanMoney.className||"moneytalksmoney",this.spanCurrency.innerHTML=this.currency,this.spanMoney.innerHTML=this.money},t.prototype.append=function(){this.bodyDiv.appendChild(this.spanMoney),this.bodyDiv.appendChild(this.spanCurrency)},t.prototype.listeners=function(){var t=this;e.on("MONEYTALKS",function(e,n){t.update(e,n)})},t.prototype.update=function(t,n){var r;r=JSUS.isNumber(t);if(r===!1){e.err("MoneyTalks.update: invalid amount: "+t);return}n&&(this.money=0),this.money+=r,this.spanMoney.innerHTML=this.money.toFixed(this.precision)},t.prototype.getValues=function(){return this.money}}(node),function(e){"use strict";function t(e){this.methods={},this.method="I-PANAS-SF",this.gauge=null,this.addMethod("I-PANAS-SF",r)}function n(e,t){if(!t)throw new Error("MoodGauge.init: method "+e+"did not create element gauge.");if("function"!=typeof t.getValues)throw new Error("MoodGauge.init: method "+e+": gauge missing function getValues.");if("function"!=typeof t.enable)throw new Error("MoodGauge.init: method "+e+": gauge missing function enable.");if("function"!=typeof t.disable)throw new Error("MoodGauge.init: method "+e+": gauge missing function disable.");if("function"!=typeof t.append)throw new Error("MoodGauge.init: method "+e+": gauge missing function append.")}function r(t){var n,r,i,s,o,u,a,f,l;"undefined"==typeof t.mainText?i="Thinking about yourself and how you normally feel, to what extent do you generally feel: ":"string"==typeof t.mainText&&(i=t.mainText),s=t.choices||["1","2","3","4","5"],r=t.emotions||["Upset","Hostile","Alert","Ashamed","Inspired","Nervous","Determined","Attentive","Afraid","Active"],o=t.left||"never",u=t.right||"always",l=r.length,n=new Array(l),f=-1;for(;++f<l;)n[f]={id:r[f],left:'<span class="emotion">'+r[f]+":</span> never",right:u,choices:s};return a=e.widgets.get("ChoiceTableGroup",{id:"ipnassf",items:n,mainText:i,title:!1,requiredChoice:!0}),a}e.widgets.register("MoodGauge",t),t.version="0.2.0",t.description="Displays an interface to measure mood and emotions.",t.title="Mood Gauge",t.className="moodgauge",t.dependencies={JSUS:{}},t.prototype.init=function(e){var t;if("undefined"!=typeof e.method){if("string"!=typeof e.method)throw new TypeError("MoodGauge.init: options.method must be string or undefined: "+e.method);if(!this.methods[e.method])throw new Error("MoodGauge.init: options.method is not a valid method: "+e.method);this.method=e.method}t=this.methods[this.method].call(this,e),n(this.method,t),this.gauge=t},t.prototype.append=function(){e.widgets.append(this.gauge,this.bodyDiv)},t.prototype.listeners=function(){},t.prototype.addMethod=function(e,t){if("string"!=typeof e)throw new Error("MoodGauge.addMethod: name must be string: "+e);if("function"!=typeof t)throw new Error("MoodGauge.addMethod: cb must be function: "+t);if(this.methods[e])throw new Error("MoodGauge.addMethod: name already existing: "+e);this.methods[e]=t},t.prototype.getValues=function(e){return this.gauge.getValues(e)},t.prototype.setValues=function(e){return this.gauge.setValues(e)},t.prototype.enable=function(){return this.gauge.enable()},t.prototype.enable=function(){return this.gauge.disable()}}(node),function(e){"use strict";function r(){this.recipient=null,this.actionSel=null,this.targetSel=null,this.table=null,this.tableAdvanced=null}function i(e,n){var r,i;if(n._invalid)return;if(e.y===2)return;if(e.y===0){n._lastKey=e.content;return}r=n._lastKey,i=e.content.value;if(r==="stage"||r==="to"||r==="data")try{i=t.parse(e.content.value)}catch(s){i=e.content.value}if(r==="to"){"number"==typeof i&&(i=""+i);if(!t.isArray(i)&&"string"!=typeof i||"string"==typeof i&&i.trim()==="")alert('Invalid "to" field'),n._invalid=!0}else r==="action"?i.trim()===""?(alert('Missing "action" field'),n._invalid=!0):i=i.toLowerCase():r==="target"&&(i.trim()===""?(alert('Missing "target" field'),n._invalid=!0):i=i.toUpperCase());n[r]=i}var t=e.JSUS,n=W.Table;e.widgets.register("MsgBar",r),r.version="0.7.0",r.description="Send a nodeGame message to players",r.title="Send MSG",r.className="msgbar",r.prototype.init=function(){this.id=this.id||r.className},r.prototype.append=function(){var t,r,i,s,o,u,a;a=this,this.table=new n,this.tableAdvanced=new n,i=["to","action","target","text","data","from","priority","reliable","forward","session","stage","created","id"];for(s=0;s<i.length;++s)o=i[s],u=s<5?this.table:this.tableAdvanced,u.add(o,s,0),u.add(W.getTextInput(this.id+"_"+o,{tabindex:s+1}),s,1),o==="to"?(this.recipient=W.getRecipientSelector(this.id+"_recipients"),W.addAttributes2Elem(this.recipient,{tabindex:i.length+1}),u.add(this.recipient,s,2),this.recipient.onchange=function(){W.getElementById(a.id+"_to").value=a.recipient.value}):o==="action"?(this.actionSel=W.getActionSelector(this.id+"_actions"),W.addAttributes2Elem(this.actionSel,{tabindex:i.length+2}),u.add(this.actionSel,s,2),this.actionSel.onchange=function(){W.getElementById(a.id+"_action").value=a.actionSel.value}):o==="target"&&(this.targetSel=W.getTargetSelector(this.id+"_targets"),W.addAttributes2Elem(this.targetSel,{tabindex:i.length+3}),u.add(this.targetSel,s,2),this.targetSel.onchange=function(){W.getElementById(a.id+"_target").value=a.targetSel.value});this.bodyDiv.appendChild(this.table.table),this.bodyDiv.appendChild(this.tableAdvanced.table),this.tableAdvanced.table.style.display="none",r=W.addButton(this.bodyDiv),r.onclick=function(){var t;t=a.parse(),t&&e.socket.send(t)},t=W.addButton(this.bodyDiv,undefined,"Toggle advanced options"),t.onclick=function(){a.tableAdvanced.table.style.display=a.tableAdvanced.table.style.display===""?"none":""},this.table.parse(),this.tableAdvanced.parse()},r.prototype.parse=function(){var t,n;return t={},this.table.forEach(i,t),t._invalid?null:(this.tableAdvanced.forEach(i,t),t._invalid?null:(delete t._lastKey,delete t._invalid,n=e.msg.create(t),e.info("MsgBar msg created. "+n.toSMS()),n))}}(node),function(e){"use strict";function r(e){this.options=e,this.nddb=null,this.commandsDiv=null,this.info=null}e.widgets.register("NDDBBrowser",r);var t=e.NDDB,n=e.TriggerManager;r.defaults={},r.defaults.id="nddbbrowser",r.defaults.fieldset=!1,r.version="0.2.0",r.description="Provides a very simple interface to control a NDDB istance.",r.dependencies={JSUS:{},NDDB:{},TriggerManager:{}},r.prototype.init=function(e){this.tm=new n,this.tm.init(e.triggers),this.nddb=e.nddb||new t({update:{pointer:!0}})},r.prototype.append=function(){function t(){var t=this.id;e.window.addEventButton(t+"_GO_TO_FIRST","<<",this.commandsDiv,"go_to_first"),e.window.addEventButton(t+"_GO_TO_PREVIOUS","<",this.commandsDiv,"go_to_previous"),e.window.addEventButton(t+"_GO_TO_NEXT",">",this.commandsDiv,"go_to_next"),e.window.addEventButton(t+"_GO_TO_LAST",">>",this.commandsDiv,"go_to_last"),e.window.addBreak(this.commandsDiv)}function n(){var e=this.commandsDiv.appendChild(document.createElement("span"));return e}this.commandsDiv=document.createElement("div"),this.id&&(this.commandsDiv.id=this.id),t.call(this),this.info=n.call(this),this.bodyDiv.appendChild(this.commandsDiv)},r.prototype.getRoot=function(e){return this.commandsDiv},r.prototype.add=function(e){return this.nddb.insert(e)},r.prototype.sort=function(e){return this.nddb.sort(e)},r.prototype.addTrigger=function(e){return this.tm.addTrigger(e)},r.prototype.removeTrigger=function(e){return this.tm.removeTrigger(e)},r.prototype.resetTriggers=function(){return this.tm.resetTriggers()},r.prototype.listeners=function(){function r(t,r){t?(e.emit(n+"_GOT",t),this.writeInfo(this.nddb.nddb_pointer+1+"/"+this.nddb.size())):this.writeInfo("No element found")}var t=this,n=this.id;e.on(n+"_GO_TO_FIRST",function(){var e=t.tm.pullTriggers(t.nddb.first());r.call(t,e)}),e.on(n+"_GO_TO_PREVIOUS",function(){var e=t.tm.pullTriggers(t.nddb.previous());r.call(t,e)}),e.on(n+"_GO_TO_NEXT",function(){var e=t.tm.pullTriggers(t.nddb.next());r.call(t,e)}),e.on(n+"_GO_TO_LAST",function(){var e=t.tm.pullTriggers(t.nddb.last());r.call(t,e)})},r.prototype.writeInfo=function(e){var t;t=this,this.infoTimeout&&clearTimeout(this.infoTimeout),this.info.innerHTML=e,this.infoTimeout=setTimeout(function(){t.info.innerHTML=""},2e3)}}(node),function(e){"use strict";function t(){this.rew=null,this.fwd=null,this.checkbox=null}function n(){var t;return t=e.game.getNextStep(),!t||t===e.GamePlot.GAMEOVER||t===e.GamePlot.END_SEQ||t===e.GamePlot.NO_SEQ?!1:!0}function r(){var t;return t=e.game.getPreviousStep(),t?!0:!1}e.widgets.register("NextPreviousStep",t),t.className="nextprevious",t.title="Next/Previous Step",t.version="1.0.0",t.description="Adds two buttons to push forward or rewind the state of the game by one step.",t.prototype.append=function(){var t,i;t=this,this.rew=document.createElement("button"),this.rew.innerHTML="<<",this.fwd=document.createElement("button"),this.fwd.innerHTML=">>",this.checkbox=document.createElement("input"),this.checkbox.type="checkbox",this.fwd.onclick=function(){t.checkbox.checked?e.done():e.game.step(),n()||(t.fwd.disabled="disabled")},this.rew.onclick=function(){var n;n=e.game.getPreviousStep(),e.game.gotoStep(n),r()||(t.rew.disabled="disabled")},r()||(this.rew.disabled="disabled"),n()||(this.fwd.disabled="disabled"),this.bodyDiv.appendChild(this.rew),this.bodyDiv.appendChild(this.fwd),i=document.createElement("span"),i.appendChild(document.createTextNode("node.done")),i.appendChild(this.checkbox),this.bodyDiv.appendChild(i)}}(node),function(e){"use strict";function n(e){function t(e){var t,n,r,s;return t="/images/"+(e.content.success?"success-icon.png":"delete-icon.png"),n=document.createElement("img"),n.src=t,"object"==typeof e.content.text&&(e.content.text=i(e.content.text)),s=document.createTextNode(e.content.text),r=document.createElement("span"),r.className="requirement",r.appendChild(n),r.appendChild(s),r}this.requirements=[],this.stillChecking=0,this.withTimeout=e.withTimeout||!0,this.timeoutTime=e.timeoutTime||1e4,this.timeoutId=null,this.summary=null,this.summaryUpdate=null,this.summaryResults=null,this.dots=null,this.hasFailed=!1,this.results=[],this.completed={},this.sayResults=e.sayResults||!1,this.sayResultsLabel=e.sayResultLabel||"requirements",this.addToResults=e.addToResults||null,this.onComplete=null,this.onSuccess=null,this.onFailure=null,this.list=new W.List({render:{pipeline:t,returnAt:"first"}})}function r(e,n,r){var i,s,o;s=function(r,i,s){if(e.completed[n])throw new Error("Requirements.checkRequirements: test already completed: "+n);e.completed[n]=!0,e.updateStillChecking(-1),r||(e.hasFailed=!0),"string"==typeof i&&(i=[i]);if(i){if(!t.isArray(i))throw new Error("Requirements.checkRequirements: errors must be array or undefined.");e.displayResults(i)}e.results.push({name:n,success:r,errors:i,data:s}),e.isCheckingFinished()&&e.checkingFinished()},i=e.requirements[r];if("function"==typeof i)o=i(s);else{if("object"!=typeof i)throw new TypeError("Requirements.checkRequirements: invalid requirement: "+n+".");o=i.cb(s,i.params||{})}o&&s(o.success,o.errors,o.data)}function i(e){var t;return e.msg?t=e.msg:e.message?t=e.message:e.description?t=t.description:t=e.toString(),t}var t=e.JSUS;e.widgets.register("Requirements",n),n.version="0.7.0",n.description="Checks a set of requirements and display the results",n.title="Requirements",n.className="requirements",n.dependencies={JSUS:{},List:{}},n.prototype.init=function(e){if("object"!=typeof e)throw new TypeError("Requirements.init: conf must be object.");if(e.requirements){if(!t.isArray(e.requirements))throw new TypeError("Requirements.init: conf.requirements must be array or undefined.");this.requirements=e.requirements}if("undefined"!=typeof e.onComplete){if(null!==e.onComplete&&"function"!=typeof e.onComplete)throw new TypeError("Requirements.init: conf.onComplete must be function, null or undefined.");this.onComplete=e.onComplete}if("undefined"!=typeof e.onSuccess){if(null!==e.onSuccess&&"function"!=typeof e.onSuccess)throw new TypeError("Requirements.init: conf.onSuccess must be function, null or undefined.");this.onSuccess=e.onSuccess}if("undefined"!=typeof e.onFailure){if(null!==e.onFailure&&"function"!=typeof e.onFailure)throw new TypeError("Requirements.init: conf.onFailure must be function, null or undefined.");this.onFailure=e.onFailure}if(e.maxExecTime){if(null!==e.maxExecTime&&"number"!=typeof e.maxExecTime)throw new TypeError("Requirements.init: conf.onMaxExecTime must be number, null or undefined.");this.withTimeout=!!e.maxExecTime,this.timeoutTime=e.maxExecTime}},n.prototype.addRequirements=function(){var e,t;e=-1,t=arguments.length;for(;++e<t;){if("function"!=typeof arguments[e]&&"object"!=typeof arguments[e])throw new TypeError("Requirements.addRequirements: requirements must be function or object.");this.requirements.push(arguments[e])}},n.prototype.checkRequirements=function(e){var t,n,s,o,u;if(!this.requirements.length)throw new Error("Requirements.checkRequirements: no requirements to check found.");this.updateStillChecking(this.requirements.length,!0),s=[],t=-1,n=this.requirements.length;for(;++t<n;){this.requirements[t]&&this.requirements[t].name?o=this.requirements[t].name:o=t+1;try{r(this,o,t)}catch(a){this.hasFailed=!0,u=i(a),this.updateStillChecking(-1),s.push("An error occurred in requirement n."+o+": "+u)}}return this.withTimeout&&this.addTimeout(),("undefined"==typeof e?!0:!1)&&this.displayResults(s),this.isCheckingFinished()&&this.checkingFinished(),s},n.prototype.addTimeout=function(){var e=this,t="One or more function is taking too long. This is likely to be due to a compatibility issue with your browser or to bad network connectivity.";this.timeoutId=setTimeout(function(){e.stillChecking>0&&e.displayResults([t]),e.timeoutId=null,e.hasFailed=!0,e.checkingFinished()},this.timeoutTime)},n.prototype.clearTimeout=function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)},n.prototype.updateStillChecking=function(e,t){var n,r;this.stillChecking=t?e:this.stillChecking+e,n=this.requirements.length,r=n-this.stillChecking,this.summaryUpdate.innerHTML=" ("+r+" / "+n+")"},n.prototype.isCheckingFinished=function(){return this.stillChecking<=0},n.prototype.checkingFinished=function(){var n;this.timeoutId&&clearTimeout(this.timeoutId),this.dots.stop(),this.sayResults&&(n={success:!this.hasFailed,results:this.results},this.addToResults&&t.mixin(n,this.addToResults()),e.say(this.sayResultsLabel,"SERVER",n)),this.onComplete&&this.onComplete(),this.hasFailed?this.onFailure&&this.onFailure():this.onSuccess&&this.onSuccess()},n.prototype.displayResults=function(e){var n,r;if(!this.list)throw new Error("Requirements.displayResults: list not found. Have you called .append() first?");if(!t.isArray(e))throw new TypeError("Requirements.displayResults: results must be array.");if(!this.hasFailed&&this.stillChecking<=0)this.list.addDT({success:!0,text:"All tests passed."});else{n=-1,r=e.length;for(;++n<r;)this.list.addDT({success:!1,text:e[n]})}this.list.parse()},n.prototype.append=function(){this.summary=document.createElement("span"),this.summary.appendChild(document.createTextNode("Evaluating requirements")),this.summaryUpdate=document.createElement("span"),this.summary.appendChild(this.summaryUpdate),this.dots=W.getLoadingDots(),this.summary.appendChild(this.dots.span),this.summaryResults=document.createElement("div"),this.summary.appendChild(document.createElement("br")),this.summary.appendChild(this.summaryResults),this.bodyDiv.appendChild(this.summary),this.bodyDiv.appendChild(this.list.getRoot())},n.prototype.listeners=function(){var t;t=this,e.registerSetup("requirements",function(n){if(!n)return;if("object"!=typeof n){e.warn("requirements widget: invalid setup object: "+n);return}return t.init(n),n.doChecking!==!1&&t.checkRequirements(),n})},n.prototype.destroy=function(){e.deregisterSetup("requirements")}}(node),function(e){"use strict";function t(e){this.methods={},this.method="Slider",this.gauge=null,this.addMethod("Slider",r)}function n(e,t){if(!t)throw new Error("SVOGauge.init: method "+e+"did not create element gauge.");if("function"!=typeof t.getValues)throw new Error("SVOGauge.init: method "+e+": gauge missing function getValues.");if("function"!=typeof t.enable)throw new Error("SVOGauge.init: method "+e+": gauge missing function enable.");if("function"!=typeof t.disable)throw new Error("SVOGauge.init: method "+e+": gauge missing function disable.");if("function"!=typeof t.append)throw new Error("SVOGauge.init: method "+e+": gauge missing function append.")}function r(t){var n,r,i,s,o,u,a,f;"undefined"==typeof t.mainText?i="Select your preferred option among those available below:":"string"==typeof t.mainText&&(i=t.mainText),r=t.sliders||[[[85,85],[85,76],[85,68],[85,59],[85,50],[85,41],[85,33],[85,24],[85,15]],[[85,15],[87,19],[89,24],[91,28],[93,33],[94,37],[96,41],[98,46],[100,50]],[[50,100],[54,98],[59,96],[63,94],[68,93],[72,91],[76,89],[81,87],[85,85]],[[50,100],[54,89],[59,79],[63,68],[68,58],[72,47],[76,36],[81,26],[85,15]],[[100,50],[94,56],[88,63],[81,69],[75,75],[69,81],[63,88],[56,94],[50,100]],[[100,50],[98,54],[96,59],[94,63],[93,68],[91,72],[89,76],[87,81],[85,85]]],this.sliders=r,f=t.renderer||function(e,t,n){e.innerHTML=t[0]+"<hr/>"+t[1]},t.left?a=t.left:a="You:<hr/>Other:",u=r.length,n=new Array(u),o=-1;for(;++o<u;)n[o]={id:o+1,left:a,choices:r[o]};return s=e.widgets.get("ChoiceTableGroup",{id:"svo_slider",items:n,mainText:i,title:!1,renderer:f,requiredChoice:!0}),s}e.widgets.register("SVOGauge",t),t.version="0.5.0",t.description="Displays an interface to measure social value orientation (S.V.O.).",t.title="SVO Gauge",t.className="svogauge",t.dependencies={JSUS:{}},t.prototype.init=function(e){var t;if("undefined"!=typeof e.method){if("string"!=typeof e.method)throw new TypeError("SVOGauge.init: options.method must be string or undefined: "+e.method);if(!this.methods[e.method])throw new Error("SVOGauge.init: options.method is not a valid method: "+e.method);this.method=e.method}t=this.methods[this.method].call(this,e),n(this.method,t),this.gauge=t},t.prototype.append=function(){e.widgets.append(this.gauge,this.bodyDiv)},t.prototype.listeners=function(){},t.prototype.addMethod=function(e,t){if("string"!=typeof e)throw new Error("SVOGauge.addMethod: name must be string: "+e);if("function"!=typeof t)throw new Error("SVOGauge.addMethod: cb must be function: "+t);if(this.methods[e])throw new Error("SVOGauge.addMethod: name already existing: "+e);this.methods[e]=t},t.prototype.getValues=function(e){return e=e||{},"undefined"==typeof e.processChoice&&(e.processChoice=function(e){return e===null?null:this.choices[e]}),this.gauge.getValues(e)},t.prototype.setValues=function(e){return this.gauge.setValues(e)},t.prototype.enable=function(){return this.gauge.enable()},t.prototype.enable=function(){return this.gauge.disable()}}(node),function(e){"use strict";function n(){this.options=null,this.displayMode=null,this.stager=null,this.gamePlot=null,this.curStage=null,this.totStage=null,this.curRound=null,this.totRound=null,this.stageOffset=null,this.totStageOffset=null,this.oldStageId=null}function r(e,t){this.name="EMPTY",this.options=t||{},this.visualRound=e,this.displayDiv=null,this.init(this.options)}function i(e,t){this.options=t||{},this.name="COUNT_UP_STAGES",this.options.toTotal&&(this.name+="_TO_TOTAL"),this.visualRound=e,this.displayDiv=null,this.curStageNumber=null,this.totStageNumber=null,this.titleDiv=null,this.textDiv=null,this.init(this.options)}function s(e,t){this.name="COUNT_DOWN_STAGES",this.options=t||{},this.visualRound=e,this.displayDiv=null,this.stagesLeft=null,this.titleDiv=null,this.init(this.options)}function o(e,t){this.options=t||{},this.name="COUNT_UP_ROUNDS",this.options.toTotal&&(this.name+="_TO_TOTAL"),this.visualRound=e,this.displayDiv=null,this.curRoundNumber=null,this.totRoundNumber=null,this.titleDiv=null,this.textDiv=null,this.init(this.options)}function u(e,t){this.name="COUNT_DOWN_ROUNDS",this.options=t||{},this.visualRound=e,this.displayDiv=null,this.roundsLeft=null,this.titleDiv=null,this.init(this.options)}function a(e,t,n){var r;this.name="";for(r in t)t.hasOwnProperty(r)&&(this.name+=t[r].name+"&");this.name=this.name.substr(0,this.name.length-1),this.options=n||{},this.visualRound=e,this.displayModes=t,this.displayDiv=null,this.init(n)}var t=e.JSUS;e.widgets.register("VisualRound",n),n.version="0.7.0",n.description="Display number of current round and/or stage.Can also display countdown and total number of rounds and/or stages.",n.title="Round info",n.className="visualround",n.dependencies={GamePlot:{},JSUS:{}},n.prototype.init=function(n){n=n||{},t.mixout(n,this.options),this.options=n,this.stageOffset=this.options.stageOffset||0,this.totStageOffset="undefined"==typeof this.options.totStageOffset?this.stageOffset:this.options.totStageOffset,this.options.flexibleMode&&(this.curStage=this.options.curStage||1,this.curStage-=this.options.stageOffset||0,this.curRound=this.options.curRound||1,this.totStage=this.options.totStage,this.totRound=this.options.totRound,this.oldStageId=this.options.oldStageId),this.gamePlot||(this.gamePlot=e.game.plot),this.stager||(this.stager=this.gamePlot.stager),this.updateInformation(),this.options.displayModeNames?this.setDisplayMode(this.options.displayModeNames):this.setDisplayMode(["COUNT_UP_ROUNDS_TO_TOTAL","COUNT_UP_STAGES_TO_TOTAL"]),this.updateDisplay()},n.prototype.append=function(){this.activate(this.displayMode),this.updateDisplay()},n.prototype.updateDisplay=function(){this.displayMode&&this.displayMode.updateDisplay()},n.prototype.setDisplayMode=function(e){var n,r,f;if(!t.isArray(e))throw TypeError;r="";for(n in e)e.hasOwnProperty(n)&&(r+=e[n]+"&");r=r.substr(0,r,r.length-1);if(this.displayMode){if(r===this.displayMode.name)return;this.deactivate(this.displayMode)}f=[];for(n in e)if(e.hasOwnProperty(n))switch(e[n]){case"COUNT_UP_STAGES_TO_TOTAL":f.push(new i(this,{toTotal:!0}));break;case"COUNT_UP_STAGES":f.push(new i(this));break;case"COUNT_DOWN_STAGES":f.push(new s(this));break;case"COUNT_UP_ROUNDS_TO_TOTAL":f.push(new o(this,{toTotal:!0}));break;case"COUNT_UP_ROUNDS":f.push(new o(this));break;case"COUNT_DOWN_ROUNDS":f.push(new u(this))}this.displayMode=new a(this,f),this.activate(this.displayMode)},n.prototype.getDisplayModeName=function(){return this.displayMode.name},n.prototype.activate=function(e){this.bodyDiv&&this.bodyDiv.appendChild(e.displayDiv),e.activate&&e.activate()},n.prototype.deactivate=function(e){this.bodyDiv.removeChild(e.displayDiv),e.deactivate&&e.deactivate()},n.prototype.listeners=function(){var t=this;e.on("STEP_CALLBACK_EXECUTED",function(){t.updateInformation()})},n.prototype.updateInformation=function(){var t,n;t=e.player.stage,t.stage===0?(this.curStage=0,this.totStage=0,this.totRound=0):this.options.flexibleMode?(t.id===this.oldStageId?this.curRound+=1:t.id&&(this.curRound=1,this.curStage+=1),this.oldStageId=t.id):(this.curStage=t.stage,"string"==typeof this.curStage&&(this.curStage=this.gamePlot.normalizeGameStage(t).stage),this.curRound=t.round,this.totRound=this.stager.sequence[this.curStage-1].num||1,this.curStage-=this.stageOffset,n=this.stager.sequence.length,this.totStage=n-this.totStageOffset,this.stager.sequence[n-1].type==="gameover"&&this.totStage--),this.updateDisplay()},r.prototype.init=function(t){this.displayDiv=e.window.getDiv(),this.displayDiv.className="rounddiv",this.updateDisplay()},r.prototype.updateDisplay=function(){},i.prototype.init=function(t){this.displayDiv=e.window.getDiv(),this.displayDiv.className="stagediv",this.titleDiv=e.window.addElement("div",this.displayDiv),this.titleDiv.className="title",this.titleDiv.innerHTML="Stage:",this.options.toTotal?(this.curStageNumber=e.window.addElement("span",this.displayDiv),this.curStageNumber.className="number"):(this.curStageNumber=e.window.addDiv(this.displayDiv),this.curStageNumber.className="number"),this.options.toTotal&&(this.textDiv=e.window.addElement("span",this.displayDiv),this.textDiv.className="text",this.textDiv.innerHTML=" of ",this.totStageNumber=e.window.addElement("span",this.displayDiv),this.totStageNumber.className="number"),this.updateDisplay()},i.prototype.updateDisplay=function(){this.curStageNumber.innerHTML=this.visualRound.curStage,this.options.toTotal&&(this.totStageNumber.innerHTML=this.visualRound.totStage||"?")},s.prototype.init=function(t){this.displayDiv=e.window.getDiv(),this.displayDiv.className="stagediv",this.titleDiv=e.window.addDiv(this.displayDiv),this.titleDiv.className="title",this.titleDiv.innerHTML="Stages left: ",this.stagesLeft=e.window.addDiv(this.displayDiv),this.stagesLeft.className="number",this.updateDisplay()},s.prototype.updateDisplay=function(){if(this.visualRound.totStage===this.visualRound.curStage){this.stagesLeft.innerHTML=0;return}this.stagesLeft.innerHTML=this.visualRound.totStage-this.visualRound.curStage||"?"},o.prototype.init=function(t){this.displayDiv=e.window.getDiv(),this.displayDiv.className="rounddiv",this.titleDiv=e.window.addElement("div",this.displayDiv),this.titleDiv.className="title",this.titleDiv.innerHTML="Round:",this.options.toTotal?(this.curRoundNumber=e.window.addElement("span",this.displayDiv),this.curRoundNumber.className="number"):(this.curRoundNumber=e.window.addDiv(this.displayDiv),this.curRoundNumber.className="number"),this.options.toTotal&&(this.textDiv=e.window.addElement("span",this.displayDiv),this.textDiv.className="text",this.textDiv.innerHTML=" of ",this.totRoundNumber=e.window.addElement("span",this.displayDiv),this.totRoundNumber.className="number"),this.updateDisplay()},o.prototype.updateDisplay=function(){this.curRoundNumber.innerHTML=this.visualRound.curRound,this.options.toTotal&&(this.totRoundNumber.innerHTML=this.visualRound.totRound||"?")},u.prototype.init=function(t){this.displayDiv=e.window.getDiv(),this.displayDiv.className="rounddiv",this.titleDiv=e.window.addDiv(this.displayDiv),this.titleDiv.className="title",this.titleDiv.innerHTML="Round left: ",this.roundsLeft=e.window.addDiv(this.displayDiv),this.roundsLeft.className="number",this.updateDisplay()},u.prototype.updateDisplay=function(){if(this.visualRound.totRound===this.visualRound.curRound){this.roundsLeft.innerHTML=0;return}this.roundsLeft.innerHTML=this.visualRound.totRound-this.visualRound.curRound||"?"},a.prototype.init=function(t){var n;this.displayDiv=e.window.getDiv();for(n in this.displayModes)this.displayModes.hasOwnProperty(n)&&this.displayDiv.appendChild(this.displayModes[n].displayDiv);this.updateDisplay()},a.prototype.updateDisplay=function(){var e;for(e in this.displayModes)this.displayModes.hasOwnProperty(e)&&this.displayModes[e].updateDisplay()},a.prototype.activate=function(){var e;for(e in this.displayModes)this.displayModes.hasOwnProperty(e)&&this.displayModes[e].activate&&this.displayModes[e].activate()},a.prototype.deactivate=function(){var e;for(e in this.displayModes)this.displayModes.hasOwnProperty(e)&&this.displayModes[e].deactivate&&this.displayMode[e].deactivate()}}(node),function(e){"use strict";function n(){this.table=new t}var t=e.window.Table;e.widgets.register("VisualStage",n),n.version="0.2.2",n.description="Visually display current, previous and next stage of the game.",n.title="Stage",n.className="visualstage",n.dependencies={JSUS:{},Table:{}},n.prototype.append=function(){this.bodyDiv.appendChild(this.table.table),this.writeStage()},n.prototype.listeners=function(){var t=this;e.on("STEP_CALLBACK_EXECUTED",function(){t.writeStage()})},n.prototype.writeStage=function(){var t,n,r,i,s,o,u,a,f;t="-",n="Uninitialized",r=t,i=t,o=e.game.getCurrentGameStage(),o&&(s=e.game.plot.getStep(o),n=s?s.id:t,a=e.game.plot.previous(o),a&&(s=e.game.plot.getStep(a),r=s?s.id:t),u=e.game.plot.next(o),u&&(s=e.game.plot.getStep(u),i=s?s.id:t)),this.table.clear(!0),this.table.addRow(["Previous: ",r]),this.table.addRow(["Current: ",n]),this.table.addRow(["Next: ",i]),f=this.table.selexec("y","=",0),f.addClass("strong"),f.selexec("x","=",2).addClass("underline"),this.table.parse()}}(node),function(e){"use strict";function n(){this.gameTimer=null,this.mainBox=null,this.waitBox=null,this.activeBox=null,this.isInitialized=!1,this.options={},this.internalTimer=null}function r(t){this.boxDiv=null,this.titleDiv=null,this.bodyDiv=null,this.timeLeft=null,this.boxDiv=e.window.getDiv(),this.titleDiv=e.window.addDiv(this.boxDiv),this.bodyDiv=e.window.addDiv(this.boxDiv),this.init(t)}var t=e.JSUS;e.widgets.register("VisualTimer",n),n.version="0.9.0",n.description="Display a configurable timer for the game. Can trigger events. Only for countdown smaller than 1h.",n.title="Time left",n.className="visualtimer",n.dependencies={GameTimer:{},JSUS:{}},n.prototype.init=function(n){var i,s;n=n||{};if("object"!=typeof n)throw new TypeError("VisualTimer.init: options must be object or undefined");s={};if("undefined"!=typeof n.gameTimer){if(this.gameTimer)throw new Error("GameTimer.init: options.gameTimer cannot be set if a gameTimer is already existing: "+this.name);if("object"!=typeof n.gameTimer)throw new TypeError("VisualTimer.init: options.gameTimer must be object or undefined. Found: "+n.gameTimer);this.gameTimer=n.gameTimer}else this.isInitialized||(this.internalTimer=!0,this.gameTimer=e.timer.createTimer({name:n.name||"VisualTimer"}));if(n.hooks){if(!this.internalTimer)throw new Error("VisualTimer.init: cannot add hooks on external gameTimer.");t.isArray(n.hooks)||(s.hooks=[n.hooks])}else s.hooks=[];this.isInitialized||s.hooks.push({name:"VisualTimer_"+this.wid,hook:this.updateDisplay,ctx:this}),"undefined"!=typeof n.milliseconds&&(s.milliseconds=e.timer.parseInput("milliseconds",n.milliseconds)),"undefined"!=typeof n.update?s.update=e.timer.parseInput("update",n.update):s.update=1e3,"undefined"!=typeof n.timeup&&(s.timeup=n.timeup),this.gameTimer.init(s),i=this.gameTimer,this.options=s,"undefined"==typeof this.options.stopOnDone&&(this.options.stopOnDone=!0),"undefined"==typeof this.options.startOnPlaying&&(this.options.startOnPlaying=!0),this.options.mainBoxOptions||(this.options.mainBoxOptions={}),this.options.waitBoxOptions||(this.options.waitBoxOptions={}),t.mixout(this.options.mainBoxOptions,{classNameBody:n.className,hideTitle:!0}),t.mixout(this.options.waitBoxOptions,{title:"Max. wait timer",classNameTitle:"waitTimerTitle",classNameBody:"waitTimerBody",hideBox:!0}),this.mainBox?this.mainBox.init(this.options.mainBoxOptions):this.mainBox=new r(this.options.mainBoxOptions),this.waitBox?this.waitBox.init(this.options.waitBoxOptions):this.waitBox=new r(this.options.waitBoxOptions),this.activeBox=this.options.activeBox||this.mainBox,this.isInitialized=!0},n.prototype.append=function(){this.bodyDiv.appendChild(this.mainBox.boxDiv),this.bodyDiv.appendChild(this.waitBox.boxDiv),this.activeBox=this.mainBox,this.updateDisplay()},n.prototype.clear=function(t){var n;return t=t||{},n=this.options,this.internalTimer?(e.timer.destroyTimer(this.gameTimer),this.internalTimer=null):this.gameTimer.removeHook(this.updateHookName),this.gameTimer=null,this.activeBox=null,this.isInitialized=!1,this.init(t),n},n.prototype.updateDisplay=function(){var e,n,r;if(!this.gameTimer.milliseconds||this.gameTimer.milliseconds===0){this.activeBox.bodyDiv.innerHTML="00:00";return}e=this.gameTimer.milliseconds-this.gameTimer.timePassed,e=t.parseMilliseconds(e),n=e[2]<10?"0"+e[2]:e[2],r=e[3]<10?"0"+e[3]:e[3],this.activeBox.bodyDiv.innerHTML=n+":"+r},n.prototype.start=function(){this.updateDisplay(),this.gameTimer.start()},n.prototype.restart=function(e){this.stop(),this.init(e),this.start()},n.prototype.stop=function(e){this.gameTimer.isStopped()||(this.activeBox.timeLeft=this.gameTimer.timeLeft,this.gameTimer.stop())},n.prototype.switchActiveBoxTo=function(e){this.activeBox.timeLeft=this.gameTimer.timeLeft||0,this.activeBox=e,this.updateDisplay()},n.prototype.startWaiting=function(e){"undefined"==typeof e&&(e={}),"undefined"==typeof e.milliseconds&&(e.milliseconds=this.gameTimer.timeLeft),"undefined"==typeof e.mainBoxOptions&&(e.mainBoxOptions={}),"undefined"==typeof e.waitBoxOptions&&(e.waitBoxOptions={}),e.mainBoxOptions.classNameBody="strike",e.mainBoxOptions.timeLeft=this.gameTimer.timeLeft||0,e.activeBox=this.waitBox,e.waitBoxOptions.hideBox=!1,this.restart(e)},n.prototype.startTiming=function(e){"undefined"==typeof e&&(e={}),"undefined"==typeof e.mainBoxOptions&&(e.mainBoxOptions={}),"undefined"==typeof e.waitBoxOptions&&(e.waitBoxOptions={}),e.activeBox=this.mainBox,e.waitBoxOptions.timeLeft=this.gameTimer.timeLeft||0,e.waitBoxOptions.hideBox=!0,e.mainBoxOptions.classNameBody="",this.restart(e)},n.prototype.resume=function(){this.gameTimer.resume()},n.prototype.setToZero=function(){this.stop(),this.activeBox.bodyDiv.innerHTML="00:00",this.activeBox.setClassNameBody("strike")},n.prototype.isTimeup=function(){return this.gameTimer.isTimeup()},n.prototype.doTimeUp=function(){this.gameTimer.doTimeUp()},n.prototype.listeners=function(){var t=this;if(!this.internalTimer)return;e.on("PLAYING",function(){var e;t.options.startOnPlaying&&(e=t.gameTimer.getStepOptions(),e?(e.update=t.update,e.timeup=undefined,t.startTiming(e)):t.gameTimer.isRunning()||t.setToZero())}),e.on("REALLY_DONE",function(){t.options.stopOnDone&&(t.gameTimer.isStopped()||t.stop())})},n.prototype.destroy=function(){this.internalTimer?(e.timer.destroyTimer(this.gameTimer),this.internalTimer=null):this.gameTimer.removeHook("VisualTimer_"+this.wid),this.bodyDiv.removeChild(this.mainBox.boxDiv),this.bodyDiv.removeChild(this.waitBox.boxDiv)},r.prototype.init=function(e){e&&(e.hideTitle?this.hideTitle():this.unhideTitle(),e.hideBody?this.hideBody():this.unhideBody(),e.hideBox?this.hideBox():this.unhideBox()),this.setTitle(e.title||""),this.setClassNameTitle(e.classNameTitle||""),this.setClassNameBody(e.classNameBody||""),e.timeLeft&&(this.timeLeft=e.timeLeft)},r.prototype.hideBox=function(){this.boxDiv.style.display="none"},r.prototype.unhideBox=function(){this.boxDiv.style.display=""},r.prototype.hideTitle=function(){this.titleDiv.style.display="none"},r.prototype.unhideTitle=function(){this.titleDiv.style.display=""},r.prototype.hideBody=function(){this.bodyDiv.style.display="none"},r.prototype.unhideBody=function(){this.bodyDiv.style.display=""},r.prototype.setTitle=function(e){this.titleDiv.innerHTML=e},r.prototype.setClassNameTitle=function(e){this.titleDiv.className=e},r.prototype.setClassNameBody=function(e){this.bodyDiv.className=e}}(node),function(e){"use strict";function t(e){this.connected=0,this.poolSize=0,this.nGames=0,this.groupSize=0,this.waitTime=null,this.startDate=null,this.timeoutId=null,this.playerCountDiv=null,this.playerCount=null,this.startDateDiv=null,this.msgDiv=null,this.timerDiv=null,this.timer=null,this.dots=null,this.onTimeout=null,this.disconnectMessage=null,this.disconnectIfNotSelected=null}e.widgets.register("WaitingRoom",t),t.version="1.1.0",t.description="Displays a waiting room for clients.",t.title="Waiting Room",t.className="waitingroom",t.dependencies={JSUS:{},VisualTimer:{}},t.prototype.init=function(e){if("object"!=typeof e)throw new TypeError("WaitingRoom.init: conf must be object.");if(e.onTimeout){if("function"!=typeof e.onTimeout)throw new TypeError("WaitingRoom.init: conf.onTimeout must be function, null or undefined.");this.onTimeout=e.onTimeout}if(e.waitTime){if(null!==e.waitTime&&"number"!=typeof e.waitTime)throw new TypeError("WaitingRoom.init: conf.onMaxExecTime must be number, null or undefined.");this.waitTime=e.waitTime,this.startTimer()}e.startDate&&this.setStartDate(e.startDate);if(e.poolSize){if(e.poolSize&&"number"!=typeof e.poolSize)throw new TypeError("WaitingRoom.init: conf.poolSize must be number or undefined.");this.poolSize=e.poolSize}if(e.groupSize){if(e.groupSize&&"number"!=typeof e.groupSize)throw new TypeError("WaitingRoom.init: conf.groupSize must be number or undefined.");this.groupSize=e.groupSize}if(e.nGames){if(e.nGames&&"number"!=typeof e.nGames)throw new TypeError("WaitingRoom.init: conf.nGames must be number or undefined.");this.nGames=e.nGames}if(e.connected){if(e.connected&&"number"!=typeof e.connected)throw new TypeError("WaitingRoom.init: conf.connected must be number or undefined.");this.connected=e.connected}if(e.disconnectMessage){if("string"!=typeof e.disconnectMessage)throw new TypeError("WaitingRoom.init: conf.disconnectMessage must be string or undefined.");this.disconnectMessage=e.disconnectMessage}else this.disconnectMessage='<span style="color: red">You have been <strong>disconnected</strong>. Please try again later.</span><br><br>';if(e.disconnectIfNotSelected){if("boolean"!=typeof e.disconnectIfNotSelected)throw new TypeError("WaitingRoom.init: conf.disconnectIfNotSelected must be boolean or undefined.");this.disconnectIfNotSelected=e.disconnectIfNotSelected}else this.disconnectIfNotSelected=!1},t.prototype.startTimer=function(){var t=this;if(this.timer)return;if(!this.waitTime)return;this.timerDiv||(this.timerDiv=document.createElement("div"),this.timerDiv.id="timer-div"),this.timerDiv.appendChild(document.createTextNode("Maximum Waiting Time: ")),this.timer=e.widgets.append("VisualTimer",this.timerDiv,{milliseconds:this.waitTime,timeup:function(){t.bodyDiv.innerHTML="Waiting for too long. Please look for a HIT called <strong>ETH Descil Trouble Ticket</strong> and file a new trouble ticket reporting your experience."},update:1e3}),this.timer.setTitle(),this.timer.panelDiv.className="ng_widget visualtimer",this.bodyDiv.appendChild(this.timerDiv),this.timer.start()},t.prototype.clearTimeout=function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)},t.prototype.updateState=function(e){if(!e)return;"number"==typeof e.connected&&(this.connected=e.connected),"number"==typeof e.poolSize&&(this.poolSize=e.poolSize),"number"==typeof e.groupSize&&(this.groupSize=e.groupSize)},t.prototype.updateDisplay=function(){var e,t;this.connected>this.poolSize?(t=Math.floor(this.connected/this.groupSize),t=t>this.nGames?this.nGames:t,e=t*this.groupSize,this.playerCount.innerHTML='<span style="color:red">'+this.connected+"</span>"+" / "+this.poolSize,this.playerCountTooHigh.style.display="",this.playerCountTooHigh.innerHTML="There are more players in this waiting room than there are playslots in the game. Only "+e+" players will be selected to "+"play the game."):(this.playerCount.innerHTML=this.connected+" / "+this.poolSize,this.playerCountTooHigh.style.display="none")},t.prototype.append=function(){this.playerCountDiv=document.createElement("div"),this.playerCountDiv.id="player-count-div",this.playerCountDiv.appendChild(document.createTextNode("Waiting for All Players to Connect: ")),this.playerCount=document.createElement("p"),this.playerCount.id="player-count",this.playerCountDiv.appendChild(this.playerCount),this.playerCountTooHigh=document.createElement("div"),this.playerCountTooHigh.style.display="none",this.playerCountDiv.appendChild(this.playerCountTooHigh),this.dots=W.getLoadingDots(),this.playerCountDiv.appendChild(this.dots.span),this.bodyDiv.appendChild(this.playerCountDiv),this.startDateDiv=document.createElement("div"),this.bodyDiv.appendChild(this.startDateDiv),this.startDateDiv.style.display="none",this.msgDiv=document.createElement("div"),this.bodyDiv.appendChild(this.msgDiv),this.startDate&&this.setStartDate(this.startDate),this.waitTime&&this.startTimer()},t.prototype.listeners=function(){var t;t=this,e.registerSetup("waitroom",function(n){if(!n)return;if("object"!=typeof n){e.warn("waiting room widget: invalid setup object: "+n);return}return t.init(n),n}),e.on.data("PLAYERSCONNECTED",function(e){if(!e.data)return;t.connected=e.data,t.updateDisplay()}),e.on.data("DISPATCH",function(e){var n,r,i;e=e||{},n=e.data||{},i="<br>You have been disconnected. "+("undefined"!=typeof n.exit?"Please report this exit code: "+n.exit:"")+"<br></h3>",n.action==="AllPlayersConnected"?t.alertPlayer():n.action==="NotEnoughPlayers"?(t.bodyDiv.innerHTML='<h3 align="center" style="color: red">Thank you for your patience.<br>Unfortunately, there are not enough participants in your group to start the experiment.<br>',t.onTimeout&&t.onTimeout(e.data),t.disconnect(t.bodyDiv.innerHTML+i)):n.action==="NotSelected"?(r='<h3 align="center"><span style="color: red">Unfortunately, you were <strong>not selected</strong> to join the game this time',!1===n.shouldDispatchMoreGames||t.disconnectIfNotSelected?(t.bodyDiv.innerHTML=r+". Thank you "+"for your participation.</span></h3><br><br>",t.disconnect(t.bodyDiv.innerHTML+i)):t.msgDiv.innerHTML=r+", but you "+"may join the next one.</span> "+'<a class="hand" onclick='+'javascript:this.parentElement.innerHTML="">'+"Ok, I got it.</a></h3><br><br>"):n.action==="Disconnect"&&t.disconnect(t.bodyDiv.innerHTML+i)}),e.on.data("TIME",function(e){e=e||{},console.log("TIME IS UP!"),t.stopTimer()}),e.on.data("WAITTIME",function(e){t.updateState(e.data),t.updateDisplay()}),e.on("SOCKET_DISCONNECT",function(){t.stopTimer(),t.bodyDiv.innerHTML=t.disconnectMessage}),e.on.data("ROOM_CLOSED",function(){t.disconnect('<span style="color: red"> The waiting room is <strong>CLOSED</strong>. You have been disconnected. Please try again later.</span><br><br>')})},t.prototype.setStartDate=function(e){this.startDate=(new Date(e)).toString(),this.startDateDiv.innerHTML="Game starts at: <br>"+this.startDate,this.startDateDiv.style.display=""},t.prototype.stopTimer=function(){this.timer&&(console.log("STOPPING TIMER"),this.timer.destroy())},t.prototype.disconnect=function(t){t&&(this.disconnectMessage=t),e.socket.disconnect(),this.stopTimer()},t.prototype.alertPlayer=function(){var t,n;JSUS.playSound("/sounds/doorbell.ogg"),document.hasFocus&&document.hasFocus()?JSUS.blinkTitle("GAME STARTS!",{repeatFor:1}):(t=JSUS.blinkTitle("GAME STARTS!",{stopOnFocus:!0,stopOnClick:window}),n=function(){var e;t(),e=W.getFrame(),e&&e.removeEventListener("mouseover",n,!1)},e.events.ng.once("FRAME_GENERATED",function(e){e.addEventListener("mouseover",n,!1)}))},t.prototype.destroy=function(){this.dots&&this.dots.stop(),e.deregisterSetup("waitroom")}}(node),function(e){"use strict";function n(t){this.id=t.id||"wall",this.name=t.name||this.name,this.buffer=[],this.counter=0,this.wall=e.window.getElement("pre",this.id)}var t=e.JSUS;e.widgets.register("Wall",n),n.version="0.3.1",n.description="Intercepts all LOG events and prints them into a PRE element with an ordinal number and a timestamp.",n.title="Wall",n.className="wall",n.dependencies={JSUS:{}},n.prototype.init=function(e){e=e||{},this.counter=e.counter||this.counter},n.prototype.append=function(){return this.bodyDiv.appendChild(this.wall)},n.prototype.listeners=function(){var t=this;e.on("LOG",function(e){t.debuffer(),t.write(e)})},n.prototype.write=function(e){var n;document.readyState!=="complete"?this.buffer.push(e):(n=this.counter++ +") "+t.getTime()+" ",this.wall.innerHTML=n+e+"\n"+this.wall.innerHTML)},n.prototype.debuffer=function(){if(document.readyState==="complete"&&this.buffer.length>0){for(var e=0;e<this.buffer.length;e++)this.write(this.buffer[e]);this.buffer=[]}}}(node)